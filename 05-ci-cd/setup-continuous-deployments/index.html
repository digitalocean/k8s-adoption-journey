<!DOCTYPE html><html class=no-js lang=en> <head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta content="Hands-on tutorial for going from day-1 to production on DigitalOcean Kubernetes." name=description><link href=https://digitalocean.github.io/k8s-adoption-journey/05-ci-cd/setup-continuous-deployments/ rel=canonical><link href=../../assets/images/favicon.png rel=icon><meta content="mkdocs-1.4.0, mkdocs-material-8.5.8" name=generator><title>Set up continuous deployments - Kubernetes Adoption Journey</title><link href=../../assets/stylesheets/main.20d9efc8.min.css rel=stylesheet><link href=../../assets/stylesheets/palette.815d1a91.min.css rel=stylesheet><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback" rel=stylesheet><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><link href=../../assets/stylesheets/glightbox.min.css rel=stylesheet><style>
            html.glightbox-open { overflow: initial; height: 100%; }
            .gdesc-inner { font-size: 0.75rem; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            
                .gscrollbar-fixer { padding-right: 15px; }
                </style><script src=../../assets/javascripts/glightbox.min.js></script></head> <body data-md-color-accent data-md-color-primary data-md-color-scheme=default dir=ltr> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input autocomplete=off class=md-toggle data-md-toggle=drawer id=__drawer type=checkbox> <input autocomplete=off class=md-toggle data-md-toggle=search id=__search type=checkbox> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a class=md-skip href=#introduction> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav aria-label=Header class="md-header__inner md-grid"> <a aria-label="Kubernetes Adoption Journey" class="md-header__button md-logo" data-md-component=logo href=../.. title="Kubernetes Adoption Journey"> <img alt=logo src=../../assets/do_logo.png> </a> <label class="md-header__button md-icon" for=__drawer> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Kubernetes Adoption Journey </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Set up continuous deployments </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input aria-label="Switch to dark mode" class=md-option data-md-color-accent data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary data-md-color-scheme=default id=__palette_1 name=__palette type=radio> <label class="md-header__button md-icon" for=__palette_2 hidden title="Switch to dark mode"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"></path></svg> </label> <input aria-label="Switch to light mode" class=md-option data-md-color-accent data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary data-md-color-scheme=slate id=__palette_2 name=__palette type=radio> <label class="md-header__button md-icon" for=__palette_1 hidden title="Switch to light mode"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M12 18a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-2.69L23.31 12 20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69Z"></path></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input aria-label=Search autocapitalize=off autocomplete=off autocorrect=off class=md-search__input data-md-component=search-query name=query placeholder=Search required spellcheck=false type=text> <label class="md-search__icon md-icon" for=__search> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg> </label> <nav aria-label=Search class=md-search__options> <button aria-label=Clear class="md-search__icon md-icon" tabindex=-1 title=Clear type=reset> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a class=md-source data-md-component=source href=https://github.com/digitalocean/k8s-adoption-journey title="Go to repository"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 448 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav aria-label=Navigation class="md-nav md-nav--primary" data-md-level=0> <label class=md-nav__title for=__drawer> <a aria-label="Kubernetes Adoption Journey" class="md-nav__button md-logo" data-md-component=logo href=../.. title="Kubernetes Adoption Journey"> <img alt=logo src=../../assets/do_logo.png> </a> Kubernetes Adoption Journey </label> <div class=md-nav__source> <a class=md-source data-md-component=source href=https://github.com/digitalocean/k8s-adoption-journey title="Go to repository"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 448 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a class=md-nav__link href=../..> Intro </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 id=__nav_2 type=checkbox> <label class=md-nav__link for=__nav_2> Getting started <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Getting started" class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Getting started </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../01-getting-started/installing-required-tools/ class=md-nav__link> Installing required tools </a> </li> <li class=md-nav__item> <a href=../../01-getting-started/do-api-auth/ class=md-nav__link> Authenticating with the DigitalOcean API </a> </li> <li class=md-nav__item> <a href=../../01-getting-started/setup-docr/ class=md-nav__link> Set up a Digital Ocean container registry </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_4 id=__nav_2_4 type=checkbox> <label class=md-nav__link for=__nav_2_4> Preparing the demo application <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Preparing the demo application" class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> Preparing the demo application </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../01-getting-started/building-and-pushing-docker-images/introduction-and-repository-setup/ class=md-nav__link> Repository setup </a> </li> <li class=md-nav__item> <a href=../../01-getting-started/building-and-pushing-docker-images/building-and-pushing-images-using-docker/ class=md-nav__link> Building and pushing images with Docker </a> </li> <li class=md-nav__item> <a href=../../01-getting-started/building-and-pushing-docker-images/building-and-pushing-images-using-cnb/ class=md-nav__link> Building and pushing images with Cloud Native Buildpacks </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 id=__nav_3 type=checkbox> <label class=md-nav__link for=__nav_3> Development environment <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Development environment" class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Development environment </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../02-development/setup-doks-dev/ class=md-nav__link> Set up Development DOKS </a> </li> <li class=md-nav__item> <a href=../../02-development/tilt-local/ class=md-nav__link> Tilt for local development </a> </li> <li class=md-nav__item> <a href=../../02-development/tilt-remote/ class=md-nav__link> Tilt for remote development </a> </li> <li class=md-nav__item> <a href=../../02-development/setup-ingress-dev/ class=md-nav__link> Set up ingress </a> </li> <li class=md-nav__item> <a href=../../02-development/observability-dev/ class=md-nav__link> Observability </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 id=__nav_4 type=checkbox> <label class=md-nav__link for=__nav_4> Staging environment <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Staging environment" class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Staging environment </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../03-staging/setup-doks-staging/ class=md-nav__link> Set up Staging DOKS </a> </li> <li class=md-nav__item> <a href=../../03-staging/deploying-the-online-boutique-sample-application-staging/ class=md-nav__link> Deploying the online boutique sample application </a> </li> <li class=md-nav__item> <a href=../../03-staging/setup-ingress-staging/ class=md-nav__link> Set up ingress </a> </li> <li class=md-nav__item> <a href=../../03-staging/observability-staging/ class=md-nav__link> Observability </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5 id=__nav_5 type=checkbox> <label class=md-nav__link for=__nav_5> Production environment <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Production environment" class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Production environment </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../04-production/setup-doks-production/ class=md-nav__link> Set up Production DOKS </a> </li> <li class=md-nav__item> <a href=../../04-production/deploying-the-online-boutique-sample-application-production/ class=md-nav__link> Deploying the online boutique sample application </a> </li> <li class=md-nav__item> <a href=../../04-production/setup-ingress-production/ class=md-nav__link> Set up ingress </a> </li> <li class=md-nav__item> <a href=../../04-production/observability-production/ class=md-nav__link> Observability </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input checked class="md-nav__toggle md-toggle" data-md-toggle=__nav_6 id=__nav_6 type=checkbox> <label class=md-nav__link for=__nav_6> Continuous integration and deployments <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Continuous integration and deployments" class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Continuous integration and deployments </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../setup-continuous-integration/ class=md-nav__link> Set up continuous integration </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc id=__toc type=checkbox> <label class="md-nav__link md-nav__link--active" for=__toc> Set up continuous deployments <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Set up continuous deployments </a> <nav aria-label="Table of contents" class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a class=md-nav__link href=#introduction> Introduction </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#prerequisites> Prerequisites </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#bootstrapping-argo-cd-for-the-development-environment> Bootstrapping Argo CD for the Development Environment </a> <nav aria-label="Bootstrapping Argo CD for the Development Environment" class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#bootstrap-instructions> Bootstrap Instructions </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#understanding-gitops-repository-layout> Understanding GitOps Repository Layout </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#managing-argo-cd-applications> Managing Argo CD Applications </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a class=md-nav__link href=#bootstrapping-argo-cd-for-the-staging-environment> Bootstrapping Argo CD for the Staging Environment </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#bootstrapping-argo-cd-for-the-production-environment> Bootstrapping Argo CD for the Production Environment </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#testing-the-final-setup> Testing the Final Setup </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#reverting-bad-application-deployments> Reverting Bad Application Deployments </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#restoring-a-lost-argo-cd-instance> Restoring a Lost Argo CD Instance </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_7 id=__nav_7 type=checkbox> <label class=md-nav__link for=__nav_7> Promote releases <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Promote releases" class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Promote releases </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../06-promote-releases/setup-release-process/ class=md-nav__link> Set up release process </a> </li> <li class=md-nav__item> <a href=../../06-promote-releases/promote-releases-to-upper-envs/ class=md-nav__link> Promote releases to upper environments </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_8 id=__nav_8 type=checkbox> <label class=md-nav__link for=__nav_8> Security <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Security class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> Security </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../07-security/software-supply-chain/ class=md-nav__link> Securing the software supply chain </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav aria-label="Table of contents" class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a class=md-nav__link href=#introduction> Introduction </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#prerequisites> Prerequisites </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#bootstrapping-argo-cd-for-the-development-environment> Bootstrapping Argo CD for the Development Environment </a> <nav aria-label="Bootstrapping Argo CD for the Development Environment" class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#bootstrap-instructions> Bootstrap Instructions </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#understanding-gitops-repository-layout> Understanding GitOps Repository Layout </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#managing-argo-cd-applications> Managing Argo CD Applications </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a class=md-nav__link href=#bootstrapping-argo-cd-for-the-staging-environment> Bootstrapping Argo CD for the Staging Environment </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#bootstrapping-argo-cd-for-the-production-environment> Bootstrapping Argo CD for the Production Environment </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#testing-the-final-setup> Testing the Final Setup </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#reverting-bad-application-deployments> Reverting Bad Application Deployments </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#restoring-a-lost-argo-cd-instance> Restoring a Lost Argo CD Instance </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a class="md-content__button md-icon" href=https://github.com/digitalocean/k8s-adoption-journey/edit/master/docs/05-ci-cd/setup-continuous-deployments.md title="Edit this page"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"></path></svg> </a> <h1>Set up continuous deployments</h1> <h2 id=introduction>Introduction</h2> <p>After setting up the CI process, the next step is to configure automated (or continuous) deployments for your environments. In some setups, continuous deployments is not desired. In the end, it all drills down to how often you want to deliver release for your project. If the release cycle and cadence of your project is more agile and you want to deliver more releases in a short period of time, then it makes sense to have such an automated setup.</p> <p>In practice, this is not the only reason. You will want some environments such as the development environment to continuously reflect latest code changes of your main application repository branch. Here is where continuous deployments play an important role. Another important aspect is - how do you track each change and what is deployed where?</p> <p>To answer all above questions, a new concept is introduced called <a href=https://www.gitops.tech/ >GitOps</a>. GitOps is yet another set of methodologies and accompanying practices, allowing automated deployments and easy track of changes for all your application deployments to various environments. It relies on Git as the single source of truth. It means, you rely on the Git history feature to track all changes, and revert the system to a previous working state in case something goes bad.</p> <p>One popular solution used to implement GitOps principles is <a href=https://argoproj.github.io/cd/ >Argo CD</a>, a free and open source project very well supported by the community. Argo CD is a declarative, GitOps continuous delivery tool for Kubernetes.</p> <p><strong>Where does Argo CD fit in?</strong></p> <p>Argo CD sits at the very end of your CI process. It waits for changes to happen in your Git repository over it is watching. No need to create and maintain separate GitHub workflows for deploying application components to each environment. Just tell Argo about your GitHub repository, and what Kubernetes cluster to sync with. Then, let Argo CD do the heavy lifting.</p> <p><strong>Do I need to create separate GitHub repositories and/or branches to sync each Kubernetes environment?</strong></p> <p>The short answer is no. No, you don't have to do this. Because you already use Kustomize overlays in your project, you have full control over the deployment process to each environment. No need to create separate branches to target each environment, which is hard to maintain and not recommended.</p> <p>For small projects it is often enough to use a monorepo structure where you have both application code and Kubernetes configuration manifests. In case of bigger projects, it's best to split application code and Kubernetes stuff into separate repositories. It's easier to track application vs Kubernetes changes this way.</p> <p>This guides relies on a monorepo approach, but it should be relatively easy to migrate to a split repo setup because all Kubernetes manifests are kept in the <a href=https://github.com/digitalocean/kubernetes-sample-apps/tree/master/microservices-demo/kustomize/ >kustomize</a> subfolder.</p> <p><strong>Do I need a separate Argo CD instance per environment or just one connecting all?</strong></p> <p>You can go either one or the other. This guide is using a separate ArgoCD instance per environment. This kind of setup doesn't affect one environment or the other if one ArgoCD instance goes down, or even if one of the clusters is in a degraded state. Only the current environment where Argo operates is affected. This is called a decentralized setup. The only drawback of this configuration is that application specific resources and system specific resources operate in the same DOKS cluster which leads to additional CPU and/or memory usage.</p> <p>Another kind of setup (not covered in this guide) is where you have one dedicated DOKS instance (or a dedicated node pool) to serve this purpose. This is called a centralized setup where one Argo CD instance manages all environments from a single place. Main advantage is user application is now decoupled from system apps, and more resources become available for the app you're developing. Main disadvantage is additional costs for operating a dedicated cluster. Another drawback is possible Argo CD downtime for all environments if HA is not properly configured, or if the cluster is not properly sized to handle multiple Argo projects and applications.</p> <p>Following diagram depicts the Argo CD setup used in this guide for each environment (decentralized setup):</p> <p><a class=glightbox data-desc-position=bottom data-description data-height=auto data-title data-width=100% href=../assets/images/cd/argocd_main_setup.png><img alt="Argo CD Decentralized Setup" src=../assets/images/cd/argocd_main_setup.png></a></p> <p>It's important to understand Argo CD concepts, so please follow the official <a href=https://argo-cd.readthedocs.io/en/stable/getting_started/ >getting started guide</a>. To keep it short, you need to know how to operate Argo <a href=https://argo-cd.readthedocs.io/en/stable/operator-manual/declarative-setup/#applications>applications</a> and <a href=https://argo-cd.readthedocs.io/en/stable/user-guide/projects/ >projects</a>. The application CRD is the most important bit of configuration dealing with connecting various sources such as Git repositories and Kubernetes clusters. On the other hand, Argo CD projects represent a logical way of grouping multiple applications related to each other.</p> <p>This chapter relies on the <a href=https://argocd-autopilot.readthedocs.io/ >Argo CD Autopilot</a> project to bootstrap Argo itself, as well as example applications (i.e. <code>microservices-demo</code>).</p> <p><strong>Why use Argo CD autopilot?</strong></p> <p>Some people argue that the <a href=https://argo-cd.readthedocs.io/en/stable/operator-manual/cluster-bootstrapping/ >app of apps pattern</a> solves all problems related to bootstrapping Argo apps and projects. This is true, but there are some missing pieces:</p> <ol> <li>Argo CD has to be installed first (this is a one time operation usually, so maybe not a big deal).</li> <li>You have to create initial manifest(s) for Argo to consume (including the manifest implementing the <strong>app of apps pattern</strong>).</li> <li>Create and layout your GitOps repository.</li> <li>Enforce a set of best practices for your GitOps repository.</li> <li>Commit and push required Argo manifests to your GitOps repository.</li> <li>Tell Argo about your intentions which requires <code>kubectl apply</code> for the involved manifests.</li> </ol> <p>The Argo CD autopilot project tries to solve all enumerated steps above. It uses an opinionated way to bootstrap your GitOps environment, and embeds a set of best practices to layout your Argo apps and projects in a GitOps fashion. On top of that, Argo CD is bootstrapped as well on your target cluster with just only one command. When needed, the autopilot CLI can be used to repeat the bootstrap process if your cluster is re-created, without pushing all manifests again to your existing repo (a special flag exists, called <code>--recover</code>).</p> <p>To summarize, here's what Argo CD autopilot can do for you:</p> <ul> <li>Creates a GitOps repository (if doesn't exists) using an opinionated approach for your Argo apps and projects.</li> <li>Bootstraps Argo CD on your DOKS cluster, and keeps itself in sync using same GitOps repo.</li> <li>Helps you create apps and projects which are then automatically synced by your Argo instance (no need to run <code>kubectl apply</code>).</li> <li>Enforces a set of best practices for all operations.</li> </ul> <p>Next, you will learn how to bootstrap Argo CD for each environment using the autopilot CLI. The procedure is basically the same, so once you learn how to do it for one environment, it should be pretty straightforward to perform the same steps for the remaining ones.</p> <h2 id=prerequisites>Prerequisites</h2> <p>To complete this section you will need:</p> <ol> <li>A container registry already set up as explained in the <a href=../../01-getting-started/setup-docr/ >Getting Started -&gt; Set up DOCR</a> section. Also, make sure the initial version (<code>v1.0.0</code>) for the demo application is already pushed to your DOCR as explained in the same chapter.</li> <li>A DOKS cluster set up and running for each environment:<ul> <li><a href=../../02-development/setup-doks-dev/ >Development Environment -&gt; Set up DOKS</a></li> <li><a href=../../03-staging/setup-doks-staging/ >Staging Environment -&gt; Set up DOKS</a></li> <li><a href=../../04-production/setup-doks-production/ >Production Environment -&gt; Set up DOKS</a></li> </ul> </li> <li>The <code>microservices-demo</code> GitHub repository already prepared as explained in the <a href=../../01-getting-started/building-and-pushing-docker-images/introduction-and-repository-setup/ >Preparing demo application GitHub repository</a> section.</li> <li><a href=https://argocd-autopilot.readthedocs.io/en/stable/Installation-Guide/ >Argo CD Autopilot CLI</a> installed for your distribution as explained in the official docs.</li> <li>A <a href=https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token/ >GitHub Personal Access Token</a> (or PAT for short) with the <code>repo</code> permissions set. It is required only once by the autopilot CLI to bootstrap Argo CD to your cluster for each environment.</li> </ol> <h2 id=bootstrapping-argo-cd-for-the-development-environment>Bootstrapping Argo CD for the Development Environment</h2> <p>In this section you will deploy Argo CD to your <code>development</code> DOKS cluster using the autopilot CLI . Then, you will configure Argo to sync application changes using the <code>dev</code> overlay folder from your <code>microservices-demo</code> GitHub repository.</p> <p>The <a href=https://argocd-autopilot.readthedocs.io>Argo CD autopilot project</a> aims to ease the initial bootstrapping process of your Argo instance for each environment. What is nice about this approach is that the Argo installation itself is also synced with your GitHub repo in a GitOps fashion. The autopilot CLI will first deploy Argo CD in your cluster, and then push all required manifests to your GitHub repository.</p> <h3 id=bootstrap-instructions>Bootstrap Instructions</h3> <div class="admonition note"> <p class=admonition-title>Note</p> <p>You may need to temporarily disable main branch protection to perform the following steps.</p> </div> <p>Please follow below steps to bootstrap Argo CD, and deploy the <code>microservices-demo</code> app to the <code>development environment</code>:</p> <ol> <li> <p>Export the <code>GIT_TOKEN</code> environment variable containing your GitHub personal access token (make sure to replace the <code>&lt;&gt;</code> placeholders first):</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-0-1 id=__codelineno-0-1 name=__codelineno-0-1></a><span class=nb>export</span> <span class=nv>GIT_TOKEN</span><span class=o>=</span>&lt;YOUR_GITHUB_PERSONAL_ACCESS_TOKEN_HERE&gt;
</code></pre></div> </li> <li> <p>Switch Kubernetes context to your <code>microservices-demo-dev</code> cluster (notice that cluster name is prefixed using the <code>do-&lt;region&gt;-</code> identifier):</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-1-1 id=__codelineno-1-1 name=__codelineno-1-1></a>kubectl config set-context <span class=k>do</span>-nyc1-microservices-demo-dev
</code></pre></div> </li> <li> <p>Bootstrap Argo CD for the development DOKS cluster using the autopilot CLI. You need to do this only once on a fresh cluster (make sure to replace the <code>&lt;&gt;</code> placeholders first):</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-2-1 id=__codelineno-2-1 name=__codelineno-2-1></a>argocd-autopilot repo bootstrap <span class=se>\</span>
<a href=#__codelineno-2-2 id=__codelineno-2-2 name=__codelineno-2-2></a>    --repo <span class=s2>"https://github.com/&lt;YOUR_GITHUB_USERNAME&gt;/microservices-demo/argocd/dev"</span>
</code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <ul> <li>Once the process finishes successfully you will receive instructions how to access the Argo CD web interface. Most important, you will get the admin user password - put it safe for later use.</li> <li>Also, a new folder should be present in your Git repository - <code>argocd/dev</code>, containing all manifests for the <code>Argo CD dev</code> environment instance. The same folder is synced by Argo to keep itself up to date, thus following GitOps principles.</li> </ul> </div> </li> <li> <p>Check if the <code>Argo CD dev</code> instance is up and running:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-3-1 id=__codelineno-3-1 name=__codelineno-3-1></a>kubectl get deployments -n argocd
</code></pre></div> <p>The output looks similar to:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-4-1 id=__codelineno-4-1 name=__codelineno-4-1></a>NAME                               READY   UP-TO-DATE   AVAILABLE   AGE
<a href=#__codelineno-4-2 id=__codelineno-4-2 name=__codelineno-4-2></a>argocd-applicationset-controller   1/1     1            1           15m
<a href=#__codelineno-4-3 id=__codelineno-4-3 name=__codelineno-4-3></a>argocd-dex-server                  1/1     1            1           15m
<a href=#__codelineno-4-4 id=__codelineno-4-4 name=__codelineno-4-4></a>argocd-notifications-controller    1/1     1            1           15m
<a href=#__codelineno-4-5 id=__codelineno-4-5 name=__codelineno-4-5></a>argocd-redis                       1/1     1            1           15m
<a href=#__codelineno-4-6 id=__codelineno-4-6 name=__codelineno-4-6></a>argocd-repo-server                 1/1     1            1           15m
<a href=#__codelineno-4-7 id=__codelineno-4-7 name=__codelineno-4-7></a>argocd-server                      1/1     1            1           15m
</code></pre></div> <p>All Argo CD deployments must be healthy and running.</p> </li> <li> <p>Create an Argo project for the <code>dev</code> environment (make sure to replace the <code>&lt;&gt;</code> placeholders first):</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-5-1 id=__codelineno-5-1 name=__codelineno-5-1></a>argocd-autopilot project create dev <span class=se>\</span>
<a href=#__codelineno-5-2 id=__codelineno-5-2 name=__codelineno-5-2></a>    --repo <span class=s2>"https://github.com/&lt;YOUR_GITHUB_USERNAME&gt;/microservices-demo/argocd/dev"</span>
</code></pre></div> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>It's best practice to organize your Argo applications using projects. For example, you can use Argo projects to define environments, such as in the above example.</p> </div> </li> <li> <p>Finally, create an Argo application for the <code>microservices-demo</code> project using the Kustomize <code>dev</code> overlay (make sure to replace the <code>&lt;&gt;</code> placeholders first):</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-6-1 id=__codelineno-6-1 name=__codelineno-6-1></a>argocd-autopilot app create microservices-demo <span class=se>\</span>
<a href=#__codelineno-6-2 id=__codelineno-6-2 name=__codelineno-6-2></a>    --app <span class=s2>"https://github.com/&lt;YOUR_GITHUB_USERNAME&gt;/microservices-demo/kustomize/dev"</span> <span class=se>\</span>
<a href=#__codelineno-6-3 id=__codelineno-6-3 name=__codelineno-6-3></a>    --repo <span class=s2>"https://github.com/&lt;YOUR_GITHUB_USERNAME&gt;/microservices-demo/argocd/dev"</span> <span class=se>\</span>
<a href=#__codelineno-6-4 id=__codelineno-6-4 name=__codelineno-6-4></a>    --project dev <span class=se>\</span>
<a href=#__codelineno-6-5 id=__codelineno-6-5 name=__codelineno-6-5></a>    --type kustomize
</code></pre></div> <p>Explanations for the above command:</p> <ul> <li><code>--app</code> - the application specifier. Here, autopilot CLI expects the repository URL and path to sync in the following format - <code>https://github.com/&lt;GITHUB_USERNAME&gt;/&lt;REPO_NAME&gt;/&lt;APP_PATH&gt;</code>. Above example uses the <code>kustomize/dev</code> overlay path for the <code>microservices-demo</code> repo because that's what renders the final application manifests for the specific environment.</li> <li><code>--repo</code> - the repository URL and path where autopilot CLI commits the Argo manifests representing applications, projects, etc. Here, the same repository URL is being used, except the directory path - <code>argocd/dev</code>. In a separate note down below, you will find the main reason why this approach is used.</li> <li><code>--project</code> - Argo project name to use for the new application (created in the previous step). The given project name reflects the environment name - <code>dev</code>. This may seem confusing at the beginning because you already defined a <code>dev</code> env in the <code>kustomize/dev</code> path from the root directory of your microservices-demo repo. It seems natural to use environment names to define Argo CD projects, but in the end you can pick any name that fits best to describe your project.</li> <li> <p><code>--type</code> - tells ArgoCD the application type (kustomize or directory). The autopilot CLI is able to infer the application type by looking at the specified repo path, but most of the time it's better to be explicit rather than implicit (or let the tool guess).</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Each environment is nested using the <code>argocd</code> folder from the root directory of your <code>microservices-demo</code> project. This guide is using a monorepo approach to sync all environments, hence the reason. By default, autopilot CLI puts everything in the root directory of your GitHub repo resulting in a mess if no path is specified.</p> </div> </li> </ul> </li> </ol> <p>Now, check if Argo created the microservices-demo application. First, port-forward the Argo web interface:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-7-1 id=__codelineno-7-1 name=__codelineno-7-1></a>kubectl port-forward -n argocd svc/argocd-server <span class=m>8080</span>:80
</code></pre></div> <p>Open the Argo CD dashboard in your web browser using this link - <a href=https://localhost:8080/ >localhost:8080</a>:</p> <p><a class=glightbox data-desc-position=bottom data-description data-height=auto data-title data-width=100% href=../assets/images/cd/microservices-demo-app-dashboard.png><img alt="Demo App Argo CD Dashboard" src=../assets/images/cd/microservices-demo-app-dashboard.png></a></p> <p>If everything went well, you should see the <code>dev-microservices-demo</code> app created and synced successfully.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <ul> <li>Argo CD is using this naming convention - <code>&lt;project_name&gt;-&lt;app_name&gt;</code>, hence the <code>dev-microservices-demo</code> name for the application.</li> <li>Please bear in mind that Argo CD is using the Git polling method by default which takes around <strong>3 minutes</strong> to trigger, hence changes are not propagated instantly.</li> </ul> </div> <p>Next, click on the <code>dev-microservices-demo</code> app tile - you should see the online boutique application composition (microservices):</p> <p><a class=glightbox data-desc-position=bottom data-description data-height=auto data-title data-width=100% href=../assets/images/cd/microservices-demo-app-composition.png><img alt="Online Boutique App Composition" src=../assets/images/cd/microservices-demo-app-composition.png></a></p> <p>Finally, port-forward the frontend service to check the online boutique application status:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-8-1 id=__codelineno-8-1 name=__codelineno-8-1></a>kubectl port-forward -n microservices-demo-dev svc/frontend <span class=m>9090</span>:80
</code></pre></div> <p>Open a web browser pointing to <a href=http://localhost:9090/ >localhost:9090</a> - you should see the online boutique application landing page.</p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>You should see the previous changes that you made in the <a href=../setup-continuous-integration/#testing-the-online-boutique-application-github-workflows>Set up continuous integration -&gt; Testing the Online Boutique Application GitHub Workflows</a> chapter applied as well.</p> </div> <h3 id=understanding-gitops-repository-layout>Understanding GitOps Repository Layout</h3> <p>The Argo CD autopilot project is using an opinionated approach to structure your GitOps repository. It does this by creating dedicated folders to store your Argo applications, projects, etc. Following directory structure is created for you automatically in the <code>argocd/dev</code> subfolder (this is the base folder used by Argo to sync your development environment):</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-9-1 id=__codelineno-9-1 name=__codelineno-9-1></a>argocd/dev/
<a href=#__codelineno-9-2 id=__codelineno-9-2 name=__codelineno-9-2></a>├── apps
<a href=#__codelineno-9-3 id=__codelineno-9-3 name=__codelineno-9-3></a>│   ├── README.md
<a href=#__codelineno-9-4 id=__codelineno-9-4 name=__codelineno-9-4></a>│   └── microservices-demo
<a href=#__codelineno-9-5 id=__codelineno-9-5 name=__codelineno-9-5></a>│       ├── base
<a href=#__codelineno-9-6 id=__codelineno-9-6 name=__codelineno-9-6></a>│       │   └── kustomization.yaml
<a href=#__codelineno-9-7 id=__codelineno-9-7 name=__codelineno-9-7></a>│       └── overlays
<a href=#__codelineno-9-8 id=__codelineno-9-8 name=__codelineno-9-8></a>│           └── dev
<a href=#__codelineno-9-9 id=__codelineno-9-9 name=__codelineno-9-9></a>│               ├── config.json
<a href=#__codelineno-9-10 id=__codelineno-9-10 name=__codelineno-9-10></a>│               └── kustomization.yaml
<a href=#__codelineno-9-11 id=__codelineno-9-11 name=__codelineno-9-11></a>├── bootstrap
<a href=#__codelineno-9-12 id=__codelineno-9-12 name=__codelineno-9-12></a>│   ├── argo-cd
<a href=#__codelineno-9-13 id=__codelineno-9-13 name=__codelineno-9-13></a>│   │   └── kustomization.yaml
<a href=#__codelineno-9-14 id=__codelineno-9-14 name=__codelineno-9-14></a>│   ├── argo-cd.yaml
<a href=#__codelineno-9-15 id=__codelineno-9-15 name=__codelineno-9-15></a>│   ├── cluster-resources
<a href=#__codelineno-9-16 id=__codelineno-9-16 name=__codelineno-9-16></a>│   │   ├── in-cluster
<a href=#__codelineno-9-17 id=__codelineno-9-17 name=__codelineno-9-17></a>│   │   │   ├── README.md
<a href=#__codelineno-9-18 id=__codelineno-9-18 name=__codelineno-9-18></a>│   │   │   └── argocd-ns.yaml
<a href=#__codelineno-9-19 id=__codelineno-9-19 name=__codelineno-9-19></a>│   │   └── in-cluster.json
<a href=#__codelineno-9-20 id=__codelineno-9-20 name=__codelineno-9-20></a>│   ├── cluster-resources.yaml
<a href=#__codelineno-9-21 id=__codelineno-9-21 name=__codelineno-9-21></a>│   └── root.yaml
<a href=#__codelineno-9-22 id=__codelineno-9-22 name=__codelineno-9-22></a>└── projects
<a href=#__codelineno-9-23 id=__codelineno-9-23 name=__codelineno-9-23></a>    ├── README.md
<a href=#__codelineno-9-24 id=__codelineno-9-24 name=__codelineno-9-24></a>    └── dev.yaml
</code></pre></div> <p>Explanations for the above structure:</p> <ul> <li><code>apps</code> - this is the main subfolder where you store all your Argo applications such as the <code>microservice-demo</code> project used in this guide. Each application you create in this subfolder is automatically synced by Argo to your target cluster. You'll also find a <code>README</code> file in this folder with additional explanations (automatically generated by the autopilot CLI).</li> <li><code>bootstrap</code> - this is where Argo stores all manifests used to bootstrap itself. Usually you don't need to touch this folder unless upgrading Argo to a newer version.</li> <li><code>projects</code> - this is the main subfolder where you store all your Argo projects. Projects are a way to logically group related Argo applications stored in the <code>apps</code> folder. You'll also find a <code>README</code> file in this folder with additional explanations (automatically generated by the autopilot CLI).</li> </ul> <p><strong>How does Argo know how to sync your microservices-demo app for the dev environment?</strong></p> <p>Argo is watching over the <code>argocd/dev</code> path from your repo for changes. The microservices-demo app is stored under the same directory. If you take a look at the <code>argocd/dev/apps/microservices-demo/base/kustomization.yaml</code> manifest, you will see that it points to the <code>kustomize/dev</code> path from the main repo:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-10-1 id=__codelineno-10-1 name=__codelineno-10-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kustomize.config.k8s.io/v1beta1</span><span class=w></span>
<a href=#__codelineno-10-2 id=__codelineno-10-2 name=__codelineno-10-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Kustomization</span><span class=w></span>
<a href=#__codelineno-10-3 id=__codelineno-10-3 name=__codelineno-10-3></a><span class=nt>resources</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-10-4 id=__codelineno-10-4 name=__codelineno-10-4></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/&lt;YOUR_GITHUB_USERNAME&gt;/microservices-demo/kustomize/dev</span><span class=w></span>
</code></pre></div> <p>So, whenever you commit something in the <code>kustomize/dev</code> path, Argo will automatically pick up the changes, and sync the <code>microservices-demo</code> application for your <code>dev</code> environment.</p> <h3 id=managing-argo-cd-applications>Managing Argo CD Applications</h3> <p>Argo CD autopilot can be used for adding (or bootstrapping) new applications whenever needed. However, when you need to change or upgrade existing apps it is advised to use Git operations to perform changes (via pull requests). In other words, use GitOps practices.</p> <p>Next, you will perform the same steps to bootstrap Argo CD for the staging environment.</p> <h2 id=bootstrapping-argo-cd-for-the-staging-environment>Bootstrapping Argo CD for the Staging Environment</h2> <p>In this section you will deploy Argo CD to your <code>staging</code> DOKS cluster using the autopilot CLI . Then, you will configure Argo to sync application changes using the <code>staging</code> overlay folder from your <code>microservices-demo</code> GitHub repository.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>You may need to temporarily disable main branch protection to perform the following steps.</p> </div> <p>Please follow below steps to bootstrap Argo CD, and deploy the <code>microservices-demo</code> app to the <code>staging environment</code>:</p> <ol> <li> <p>Export the <code>GIT_TOKEN</code> environment variable containing your GitHub personal access token, if not already (make sure to replace the <code>&lt;&gt;</code> placeholders first):</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-11-1 id=__codelineno-11-1 name=__codelineno-11-1></a><span class=nb>export</span> <span class=nv>GIT_TOKEN</span><span class=o>=</span>&lt;YOUR_GITHUB_PERSONAL_ACCESS_TOKEN_HERE&gt;
</code></pre></div> </li> <li> <p>Switch Kubernetes context to your <code>microservices-demo-staging</code> cluster (notice that cluster name is prefixed using the <code>do-&lt;region&gt;-</code> identifier):</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-12-1 id=__codelineno-12-1 name=__codelineno-12-1></a>kubectl config set-context <span class=k>do</span>-nyc1-microservices-demo-staging
</code></pre></div> </li> <li> <p>Bootstrap Argo CD for the staging DOKS cluster using the autopilot CLI. You need to do this only once on a fresh cluster (make sure to replace the <code>&lt;&gt;</code> placeholders first):</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-13-1 id=__codelineno-13-1 name=__codelineno-13-1></a>argocd-autopilot repo bootstrap <span class=se>\</span>
<a href=#__codelineno-13-2 id=__codelineno-13-2 name=__codelineno-13-2></a>    --repo <span class=s2>"https://github.com/&lt;YOUR_GITHUB_USERNAME&gt;/microservices-demo/argocd/staging"</span>
</code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <ul> <li>Once the process finishes successfully you will receive instructions how to access the Argo CD web interface. Most important, you will get the admin user password - put it safe for later use.</li> <li>Also, a new folder should be present in your Git repository - <code>argocd/staging</code>, containing all manifests for the <code>Argo CD staging</code> environment instance. The same folder is synced by Argo to keep itself up to date, thus following GitOps principles.</li> </ul> </div> </li> <li> <p>Check if the <code>Argo CD staging</code> instance is up and running:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-14-1 id=__codelineno-14-1 name=__codelineno-14-1></a>kubectl get deployments -n argocd
</code></pre></div> <p>The output looks similar to:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-15-1 id=__codelineno-15-1 name=__codelineno-15-1></a>NAME                               READY   UP-TO-DATE   AVAILABLE   AGE
<a href=#__codelineno-15-2 id=__codelineno-15-2 name=__codelineno-15-2></a>argocd-applicationset-controller   1/1     1            1           10m
<a href=#__codelineno-15-3 id=__codelineno-15-3 name=__codelineno-15-3></a>argocd-dex-server                  1/1     1            1           10m
<a href=#__codelineno-15-4 id=__codelineno-15-4 name=__codelineno-15-4></a>argocd-notifications-controller    1/1     1            1           10m
<a href=#__codelineno-15-5 id=__codelineno-15-5 name=__codelineno-15-5></a>argocd-redis                       1/1     1            1           10m
<a href=#__codelineno-15-6 id=__codelineno-15-6 name=__codelineno-15-6></a>argocd-repo-server                 1/1     1            1           10m
<a href=#__codelineno-15-7 id=__codelineno-15-7 name=__codelineno-15-7></a>argocd-server                      1/1     1            1           10m
</code></pre></div> <p>All Argo CD deployments must be healthy and running.</p> </li> <li> <p>Create an Argo project for the <code>staging</code> environment (make sure to replace the <code>&lt;&gt;</code> placeholders first):</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-16-1 id=__codelineno-16-1 name=__codelineno-16-1></a>argocd-autopilot project create staging <span class=se>\</span>
<a href=#__codelineno-16-2 id=__codelineno-16-2 name=__codelineno-16-2></a>    --repo <span class=s2>"https://github.com/&lt;YOUR_GITHUB_USERNAME&gt;/microservices-demo/argocd/staging"</span>
</code></pre></div> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>It's best practice to organize your Argo applications using projects. For example, you can use Argo projects to define environments, such as in the above example.</p> </div> </li> <li> <p>Finally, create an Argo application for the <code>microservices-demo</code> project using the Kustomize <code>staging</code> overlay (make sure to replace the <code>&lt;&gt;</code> placeholders first):</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-17-1 id=__codelineno-17-1 name=__codelineno-17-1></a>argocd-autopilot app create microservices-demo <span class=se>\</span>
<a href=#__codelineno-17-2 id=__codelineno-17-2 name=__codelineno-17-2></a>    --app <span class=s2>"https://github.com/&lt;YOUR_GITHUB_USERNAME&gt;/microservices-demo/kustomize/staging"</span> <span class=se>\</span>
<a href=#__codelineno-17-3 id=__codelineno-17-3 name=__codelineno-17-3></a>    --repo <span class=s2>"https://github.com/&lt;YOUR_GITHUB_USERNAME&gt;/microservices-demo/argocd/staging"</span> <span class=se>\</span>
<a href=#__codelineno-17-4 id=__codelineno-17-4 name=__codelineno-17-4></a>    --project staging <span class=se>\</span>
<a href=#__codelineno-17-5 id=__codelineno-17-5 name=__codelineno-17-5></a>    --type kustomize
</code></pre></div> </li> </ol> <p>To verify the whole setup works, please use the same procedure as you already learned in the <a href=#bootstrapping-argo-cd-for-the-development-environment>Bootstrapping Argo CD for the Development Environment</a> section of this chapter.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Please bear in mind that Argo CD is using the Git polling method by default which takes around <strong>3 minutes</strong> to trigger, hence changes are not propagated instantly.</p> </div> <p>The provisioned GitOps repository layout structure is similar to the dev environment, the only difference being the name. Of course, you will have environment specific details stored as well. Managing Argo CD applications goes the same way.</p> <p>Next, you will perform the same steps to bootstrap Argo CD for the production environment.</p> <h2 id=bootstrapping-argo-cd-for-the-production-environment>Bootstrapping Argo CD for the Production Environment</h2> <p>In this section you will deploy Argo CD to your <code>production</code> DOKS cluster using the autopilot CLI . Then, you will configure Argo to sync application changes using the <code>prod</code> overlay folder from your <code>microservices-demo</code> GitHub repository.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>You may need to temporarily disable main branch protection to perform the following steps.</p> </div> <p>Please follow below steps to bootstrap Argo CD, and deploy the <code>microservices-demo</code> app to the <code>production environment</code>:</p> <ol> <li> <p>Export the <code>GIT_TOKEN</code> environment variable containing your GitHub personal access token, if not already (make sure to replace the <code>&lt;&gt;</code> placeholders first):</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-18-1 id=__codelineno-18-1 name=__codelineno-18-1></a><span class=nb>export</span> <span class=nv>GIT_TOKEN</span><span class=o>=</span>&lt;YOUR_GITHUB_PERSONAL_ACCESS_TOKEN_HERE&gt;
</code></pre></div> </li> <li> <p>Switch Kubernetes context to your <code>microservices-demo-production</code> cluster (notice that cluster name is prefixed using the <code>do-&lt;region&gt;-</code> identifier):</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-19-1 id=__codelineno-19-1 name=__codelineno-19-1></a>kubectl config set-context <span class=k>do</span>-nyc1-microservices-demo-production
</code></pre></div> </li> <li> <p>Bootstrap Argo CD for the production DOKS cluster using the autopilot CLI. You need to do this only once on a fresh cluster (make sure to replace the <code>&lt;&gt;</code> placeholders first):</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-20-1 id=__codelineno-20-1 name=__codelineno-20-1></a>argocd-autopilot repo bootstrap <span class=se>\</span>
<a href=#__codelineno-20-2 id=__codelineno-20-2 name=__codelineno-20-2></a>    --repo <span class=s2>"https://github.com/&lt;YOUR_GITHUB_USERNAME&gt;/microservices-demo/argocd/prod"</span>
</code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <ul> <li>Once the process finishes successfully you will receive instructions how to access the Argo CD web interface. Most important, you will get the admin user password - put it safe for later use.</li> <li>Also, a new folder should be present in your Git repository - <code>argocd/prod</code>, containing all manifests for the <code>Argo CD production</code> environment instance. The same folder is synced by Argo to keep itself up to date, thus following GitOps principles.</li> </ul> </div> </li> <li> <p>Check if the <code>Argo CD production</code> instance is up and running:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-21-1 id=__codelineno-21-1 name=__codelineno-21-1></a>kubectl get deployments -n argocd
</code></pre></div> <p>The output looks similar to:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-22-1 id=__codelineno-22-1 name=__codelineno-22-1></a>NAME                               READY   UP-TO-DATE   AVAILABLE   AGE
<a href=#__codelineno-22-2 id=__codelineno-22-2 name=__codelineno-22-2></a>argocd-applicationset-controller   1/1     1            1           5m
<a href=#__codelineno-22-3 id=__codelineno-22-3 name=__codelineno-22-3></a>argocd-dex-server                  1/1     1            1           5m
<a href=#__codelineno-22-4 id=__codelineno-22-4 name=__codelineno-22-4></a>argocd-notifications-controller    1/1     1            1           5m
<a href=#__codelineno-22-5 id=__codelineno-22-5 name=__codelineno-22-5></a>argocd-redis                       1/1     1            1           5m
<a href=#__codelineno-22-6 id=__codelineno-22-6 name=__codelineno-22-6></a>argocd-repo-server                 1/1     1            1           5m
<a href=#__codelineno-22-7 id=__codelineno-22-7 name=__codelineno-22-7></a>argocd-server                      1/1     1            1           5m
</code></pre></div> <p>All Argo CD deployments must be healthy and running.</p> </li> <li> <p>Create an Argo project for the <code>production</code> environment (make sure to replace the <code>&lt;&gt;</code> placeholders first):</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-23-1 id=__codelineno-23-1 name=__codelineno-23-1></a>argocd-autopilot project create prod <span class=se>\</span>
<a href=#__codelineno-23-2 id=__codelineno-23-2 name=__codelineno-23-2></a>    --repo <span class=s2>"https://github.com/&lt;YOUR_GITHUB_USERNAME&gt;/microservices-demo/argocd/prod"</span>
</code></pre></div> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>It's best practice to organize your Argo applications using projects. For example, you can use Argo projects to define environments, such as in the above example.</p> </div> </li> <li> <p>Finally, create an Argo application for the <code>microservices-demo</code> project using the Kustomize <code>prod</code> overlay (make sure to replace the <code>&lt;&gt;</code> placeholders first):</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-24-1 id=__codelineno-24-1 name=__codelineno-24-1></a>argocd-autopilot app create microservices-demo <span class=se>\</span>
<a href=#__codelineno-24-2 id=__codelineno-24-2 name=__codelineno-24-2></a>    --app <span class=s2>"https://github.com/&lt;YOUR_GITHUB_USERNAME&gt;/microservices-demo/kustomize/prod"</span> <span class=se>\</span>
<a href=#__codelineno-24-3 id=__codelineno-24-3 name=__codelineno-24-3></a>    --repo <span class=s2>"https://github.com/&lt;YOUR_GITHUB_USERNAME&gt;/microservices-demo/argocd/prod"</span> <span class=se>\</span>
<a href=#__codelineno-24-4 id=__codelineno-24-4 name=__codelineno-24-4></a>    --project prod <span class=se>\</span>
<a href=#__codelineno-24-5 id=__codelineno-24-5 name=__codelineno-24-5></a>    --type kustomize
</code></pre></div> </li> </ol> <p>To verify the whole setup works, please use the same procedure as you already learned in the <a href=#bootstrapping-argo-cd-for-the-development-environment>Bootstrapping Argo CD for the Development Environment</a> section of this chapter.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Please bear in mind that Argo CD is using the Git polling method by default which takes around <strong>3 minutes</strong> to trigger, hence changes are not propagated instantly.</p> </div> <p>The provisioned GitOps repository layout structure is similar to the dev or staging environment, the only difference being the name. Of course, you will have environment specific details stored as well. Managing Argo CD applications goes the same way.</p> <h2 id=testing-the-final-setup>Testing the Final Setup</h2> <p>As an exercise, go ahead and make a change to one or even more microservices. Then, open a PR and check the associated workflow. Next, approve the PR and merge change into main branch. Check the main branch GitHub workflow as it progresses. When finished, check if Argo propagated the latest changes to your development DOKS cluster.</p> <h2 id=reverting-bad-application-deployments>Reverting Bad Application Deployments</h2> <p>Up to this point you tested only the happy CI/CD flows for the main application. In reality things may go wrong, hence it's important to know how to deal with this kind of situations as well. Because you're already using GitOps it should be easy to revert changes in case something goes bad. The only place where you need to perform changes is the GitHub repository hosting your application.</p> <p>Moving forward, everything is controlled via pull requests because you already set main branch protection rules. So, the process doesn't get out of control because no one pushes inadvertently to the main branch - this is very important to avoid configuration drifts, and bad things to happen.</p> <p>Still, even with all processes you already have in place, there's is a chance for human errors to slip. Thus, it is very important to know how to handle and recover from this situation. There are two options available:</p> <ol> <li>Use the GitHub <a href=https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/incorporating-changes-from-a-pull-request/reverting-a-pull-request>PR revert feature</a>. It is a feature present in the GitHub user interface which creates a new PR that contains one revert of the merge commit from the original merged pull request. After merging the PR into main branch, Argo CD will pickup changes and deploy the previous images for the application. This approach has a few pros and cons:<ul> <li>It is easier to revert back to the original state via single button in the GitHub user interface. It feels natural, just as you would do using the <code>Undo</code> feature from your IDE, or any other desktop application. This aspect falls into the pros category.</li> <li>It will trigger the whole set of CI workflows again. First, the PR workflow, and then the main branch workflow which rebuilds the same set of images basically but using a different commit ID. In the end, you will achieve the final goal and revert things back to their initial state, but the outcome is unnecessary images being built and additional waiting time (things may break in between also). This aspect falls more into the cons category.</li> <li>You have more control over the process, meaning you also revert the whole batch of changes for application code which may be a desired thing or not. This aspect falls more or less into the pros category.</li> </ul> </li> <li>Another option is to create a fresh PR, and revert only the <code>kustomize</code> changes to switch to the previous deployment that worked. This approach is more <code>lightweight</code> and doesn't trigger a bunch of GitHub workflows as in the first approach. On the other hand, defective application code stays in place. But, the main advantage is that you revert your application to a working state very quickly, thus it creates minimum application downtime.</li> </ol> <p>If choosing the second option, you have time to prepare a set of fixes (or hot-fixes) meanwhile. When everything is ready and you feel confident about your work, go as usual with the CI flow. Open a new PR with your code changes, obtain approval, merge into main branch, Argo CD picks up and updates the application in the development cluster.</p> <p>The first approach is already set up, so if you need to go that route there's nothing new to learn or implement. Following example is based on the second approach.</p> <p>Steps to revert a bad deployment for the development environment (applies to upper environments as well):</p> <ol> <li> <p>Identify the problematic commit ID in your application GitHub repository. You should be able to spot it quickly because it contains the following signature:</p> <p><a class=glightbox data-desc-position=bottom data-description data-height=auto data-title data-width=100% href=../assets/images/cd/github-actions-signature.png><img alt="GitHub Actions Commit Signature" src=../assets/images/cd/github-actions-signature.png></a></p> </li> <li> <p>Navigate to the respective commit ID, and see what changed:</p> <p><a class=glightbox data-desc-position=bottom data-description data-height=auto data-title data-width=100% href=../assets/images/cd/identify-img-tag-id.png><img alt="Identify Container Images Tags" src=../assets/images/cd/identify-img-tag-id.png></a></p> </li> <li> <p>Create a new PR containing changes with the previous image tag for each affected microservice (the value highlighted using red color in the Git diff shown in the above image).</p> </li> <li>Wait for the Kustomize manifests validation workflow to finish, and if everything is alright approve and merge the PR.</li> </ol> <p>After a few moments (3 minutes max), you should see the old version of the <code>microservices-demo</code> application present in your development environment.</p> <h2 id=restoring-a-lost-argo-cd-instance>Restoring a Lost Argo CD Instance</h2> <p>If for some reason the DOKS cluster is re-created and the associaged Argo CD instance is lost, then you should be able to recover from this situation using your existing GitOps repository (assuming it is still intact). It's a feature offered by the Argo CD autopilot CLI via a special flag called <code>--recover</code>.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Don't forget to integrate your new DOKS cluster with DOCR before anything else. If you forget to perform this step, all Kubernetes deployments will fail to pull application images from your registry.</p> </div> <p>Assuming you want to recover the <code>staging</code> environment Argo CD instance, please follow below steps:</p> <ol> <li> <p>Export the <code>GIT_TOKEN</code> environment variable containing your GitHub personal access token, if not already (make sure to replace the <code>&lt;&gt;</code> placeholders first):</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-25-1 id=__codelineno-25-1 name=__codelineno-25-1></a><span class=nb>export</span> <span class=nv>GIT_TOKEN</span><span class=o>=</span>&lt;YOUR_GITHUB_PERSONAL_ACCESS_TOKEN_HERE&gt;
</code></pre></div> </li> <li> <p>Switch Kubernetes context to your <code>staging</code> cluster. Below example is using <code>do-nyc1-microservices-demo-staging</code> for demonstration - make sure to change value if yours is different:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-26-1 id=__codelineno-26-1 name=__codelineno-26-1></a>kubectl config set-context <span class=k>do</span>-nyc1-microservices-demo-staging
</code></pre></div> </li> <li> <p>Run the autopilot bootstrap using the <code>--recover</code> flag this time (make sure to replace the <code>&lt;&gt;</code> placeholders first):</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-27-1 id=__codelineno-27-1 name=__codelineno-27-1></a>argocd-autopilot repo bootstrap <span class=se>\</span>
<a href=#__codelineno-27-2 id=__codelineno-27-2 name=__codelineno-27-2></a>    --repo <span class=s2>"https://github.com/&lt;YOUR_GITHUB_USERNAME&gt;/microservices-demo/argocd/staging"</span> <span class=se>\</span>
<a href=#__codelineno-27-3 id=__codelineno-27-3 name=__codelineno-27-3></a>    --recover
</code></pre></div> </li> </ol> <p>What the above command does is it will clone your GitOps repository first as specified by the <code>--repo</code> flag. Then, it will install a fresh Argo CD instance using environment specific manifests pointed by the last part of the repository path, i.e. <code>argocd/staging</code>. Environment specific applications and projects should be restored as well. GitOps repository Kustomize manifests should remain untouched.</p> <p>So far, you learned how to configure and enable an automated CI/CD flow for the development environment. Next, you will learn how to create GitHub releases for your application and propagate (or promote) changes to upper environments as well. First to the staging environment, and then after QA approval (may imply project manager decision as well), deploy to production.</p> </article> </div> </div> </main> <footer class=md-footer> <nav aria-label=Footer class="md-footer__inner md-grid"> <a aria-label="Previous: Set up continuous integration" class="md-footer__link md-footer__link--prev" href=../setup-continuous-integration/ rel=prev> <div class="md-footer__button md-icon"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Set up continuous integration </div> </div> </a> <a aria-label="Next: Set up release process" class="md-footer__link md-footer__link--next" href=../../06-promote-releases/setup-release-process/ rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Set up release process </div> </div> <div class="md-footer__button md-icon"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> DigitalOcean </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ rel=noopener target=_blank> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../../assets/javascripts/bundle.d6c3db9e.min.js></script> <script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom"});})</script></body> </html>