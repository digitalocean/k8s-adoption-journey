<!DOCTYPE html><html class=no-js lang=en> <head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta content="Hands-on tutorial for going from day-1 to production on DigitalOcean Kubernetes." name=description><link href=https://digitalocean.github.io/k8s-adoption-journey/06-promote-releases/promote-releases-to-upper-envs/ rel=canonical><link href=../../assets/images/favicon.png rel=icon><meta content="mkdocs-1.4.0, mkdocs-material-8.5.8" name=generator><title>Promote releases to upper environments - Kubernetes Adoption Journey</title><link href=../../assets/stylesheets/main.20d9efc8.min.css rel=stylesheet><link href=../../assets/stylesheets/palette.815d1a91.min.css rel=stylesheet><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback" rel=stylesheet><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><link href=../../assets/stylesheets/glightbox.min.css rel=stylesheet><style>
            html.glightbox-open { overflow: initial; height: 100%; }
            .gdesc-inner { font-size: 0.75rem; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            
                .gscrollbar-fixer { padding-right: 15px; }
                </style><script src=../../assets/javascripts/glightbox.min.js></script></head> <body data-md-color-accent data-md-color-primary data-md-color-scheme=default dir=ltr> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input autocomplete=off class=md-toggle data-md-toggle=drawer id=__drawer type=checkbox> <input autocomplete=off class=md-toggle data-md-toggle=search id=__search type=checkbox> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a class=md-skip href=#introduction> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav aria-label=Header class="md-header__inner md-grid"> <a aria-label="Kubernetes Adoption Journey" class="md-header__button md-logo" data-md-component=logo href=../.. title="Kubernetes Adoption Journey"> <img alt=logo src=../../assets/do_logo.png> </a> <label class="md-header__button md-icon" for=__drawer> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Kubernetes Adoption Journey </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Promote releases to upper environments </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input aria-label="Switch to dark mode" class=md-option data-md-color-accent data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary data-md-color-scheme=default id=__palette_1 name=__palette type=radio> <label class="md-header__button md-icon" for=__palette_2 hidden title="Switch to dark mode"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"></path></svg> </label> <input aria-label="Switch to light mode" class=md-option data-md-color-accent data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary data-md-color-scheme=slate id=__palette_2 name=__palette type=radio> <label class="md-header__button md-icon" for=__palette_1 hidden title="Switch to light mode"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M12 18a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-2.69L23.31 12 20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69Z"></path></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input aria-label=Search autocapitalize=off autocomplete=off autocorrect=off class=md-search__input data-md-component=search-query name=query placeholder=Search required spellcheck=false type=text> <label class="md-search__icon md-icon" for=__search> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg> </label> <nav aria-label=Search class=md-search__options> <button aria-label=Clear class="md-search__icon md-icon" tabindex=-1 title=Clear type=reset> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a class=md-source data-md-component=source href=https://github.com/digitalocean/k8s-adoption-journey title="Go to repository"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 448 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav aria-label=Navigation class="md-nav md-nav--primary" data-md-level=0> <label class=md-nav__title for=__drawer> <a aria-label="Kubernetes Adoption Journey" class="md-nav__button md-logo" data-md-component=logo href=../.. title="Kubernetes Adoption Journey"> <img alt=logo src=../../assets/do_logo.png> </a> Kubernetes Adoption Journey </label> <div class=md-nav__source> <a class=md-source data-md-component=source href=https://github.com/digitalocean/k8s-adoption-journey title="Go to repository"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 448 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a class=md-nav__link href=../..> Intro </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 id=__nav_2 type=checkbox> <label class=md-nav__link for=__nav_2> Getting started <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Getting started" class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Getting started </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../01-getting-started/installing-required-tools/ class=md-nav__link> Installing required tools </a> </li> <li class=md-nav__item> <a href=../../01-getting-started/do-api-auth/ class=md-nav__link> Authenticating with the DigitalOcean API </a> </li> <li class=md-nav__item> <a href=../../01-getting-started/setup-docr/ class=md-nav__link> Set up a Digital Ocean container registry </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_4 id=__nav_2_4 type=checkbox> <label class=md-nav__link for=__nav_2_4> Preparing the demo application <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Preparing the demo application" class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> Preparing the demo application </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../01-getting-started/building-and-pushing-docker-images/introduction-and-repository-setup/ class=md-nav__link> Repository setup </a> </li> <li class=md-nav__item> <a href=../../01-getting-started/building-and-pushing-docker-images/building-and-pushing-images-using-docker/ class=md-nav__link> Building and pushing images with Docker </a> </li> <li class=md-nav__item> <a href=../../01-getting-started/building-and-pushing-docker-images/building-and-pushing-images-using-cnb/ class=md-nav__link> Building and pushing images with Cloud Native Buildpacks </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 id=__nav_3 type=checkbox> <label class=md-nav__link for=__nav_3> Development environment <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Development environment" class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Development environment </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../02-development/setup-doks-dev/ class=md-nav__link> Set up Development DOKS </a> </li> <li class=md-nav__item> <a href=../../02-development/tilt-local/ class=md-nav__link> Tilt for local development </a> </li> <li class=md-nav__item> <a href=../../02-development/tilt-remote/ class=md-nav__link> Tilt for remote development </a> </li> <li class=md-nav__item> <a href=../../02-development/setup-ingress-dev/ class=md-nav__link> Set up ingress </a> </li> <li class=md-nav__item> <a href=../../02-development/observability-dev/ class=md-nav__link> Observability </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 id=__nav_4 type=checkbox> <label class=md-nav__link for=__nav_4> Staging environment <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Staging environment" class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Staging environment </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../03-staging/setup-doks-staging/ class=md-nav__link> Set up Staging DOKS </a> </li> <li class=md-nav__item> <a href=../../03-staging/deploying-the-online-boutique-sample-application-staging/ class=md-nav__link> Deploying the online boutique sample application </a> </li> <li class=md-nav__item> <a href=../../03-staging/setup-ingress-staging/ class=md-nav__link> Set up ingress </a> </li> <li class=md-nav__item> <a href=../../03-staging/observability-staging/ class=md-nav__link> Observability </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5 id=__nav_5 type=checkbox> <label class=md-nav__link for=__nav_5> Production environment <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Production environment" class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Production environment </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../04-production/setup-doks-production/ class=md-nav__link> Set up Production DOKS </a> </li> <li class=md-nav__item> <a href=../../04-production/deploying-the-online-boutique-sample-application-production/ class=md-nav__link> Deploying the online boutique sample application </a> </li> <li class=md-nav__item> <a href=../../04-production/setup-ingress-production/ class=md-nav__link> Set up ingress </a> </li> <li class=md-nav__item> <a href=../../04-production/observability-production/ class=md-nav__link> Observability </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6 id=__nav_6 type=checkbox> <label class=md-nav__link for=__nav_6> Continuous integration and deployments <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Continuous integration and deployments" class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Continuous integration and deployments </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../05-ci-cd/setup-continuous-integration/ class=md-nav__link> Set up continuous integration </a> </li> <li class=md-nav__item> <a href=../../05-ci-cd/setup-continuous-deployments/ class=md-nav__link> Set up continuous deployments </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input checked class="md-nav__toggle md-toggle" data-md-toggle=__nav_7 id=__nav_7 type=checkbox> <label class=md-nav__link for=__nav_7> Promote releases <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Promote releases" class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Promote releases </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../setup-release-process/ class=md-nav__link> Set up release process </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc id=__toc type=checkbox> <label class="md-nav__link md-nav__link--active" for=__toc> Promote releases to upper environments <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Promote releases to upper environments </a> <nav aria-label="Table of contents" class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a class=md-nav__link href=#introduction> Introduction </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#promote-releases-to-staging-environment> Promote Releases to Staging Environment </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#promote-releases-to-production-environment> Promote Releases to Production Environment </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#rollback-bad-releases> Rollback Bad Releases </a> <nav aria-label="Rollback Bad Releases" class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#github-pr-revert-feature> GitHub PR Revert Feature </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#argo-cd-application-rollback-feature> Argo CD Application Rollback Feature </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_8 id=__nav_8 type=checkbox> <label class=md-nav__link for=__nav_8> Security <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Security class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> Security </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../07-security/software-supply-chain/ class=md-nav__link> Securing the software supply chain </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav aria-label="Table of contents" class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a class=md-nav__link href=#introduction> Introduction </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#promote-releases-to-staging-environment> Promote Releases to Staging Environment </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#promote-releases-to-production-environment> Promote Releases to Production Environment </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#rollback-bad-releases> Rollback Bad Releases </a> <nav aria-label="Rollback Bad Releases" class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#github-pr-revert-feature> GitHub PR Revert Feature </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#argo-cd-application-rollback-feature> Argo CD Application Rollback Feature </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a class="md-content__button md-icon" href=https://github.com/digitalocean/k8s-adoption-journey/edit/master/docs/06-promote-releases/promote-releases-to-upper-envs.md title="Edit this page"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"></path></svg> </a> <h1>Promote releases to upper environments</h1> <h2 id=introduction>Introduction</h2> <p>In general, it's not best practice to immediately deploy to production after each new release. You will want to deploy to staging environment first, then have QA team check and approve the release. If everything is ok, then you will move forward and deploy to production.</p> <p>Promoting a new release to upper environments should happen in a controlled manner via pull requests. This approach ensures atomic changes for each environment. In case something goes wrong, you will revert last PR changes causing issues.</p> <h2 id=promote-releases-to-staging-environment>Promote Releases to Staging Environment</h2> <p>You already have automated deployments enabled for the staging environment from <a href=../setup-release-process/ >previous chapter</a>. In other words, releases are automatically promoted to the staging environment.</p> <p>This approach is safe in general and preferred because the staging environment is used by QA teams testing your product. On the other hand, the same environment is shared with your clients (or customers) so that they can test or preview new features before releasing to production.</p> <p>Following diagram shows the high level overview of the process:</p> <pre class=mermaid><code>graph TD
A(New Application Release) -- "Promote &lt;br/&gt; #40;Automated Process#41;" --&gt; B(Staging Environment)
B --&gt; C(QA Testing)
C --&gt; D{Release Approved?}
D -- No --&gt; E(Reject Release)
D -- Yes --&gt; F(Valid Release)</code></pre> <p>Once the new release is promoted to staging, the next logical step is for QA team to kick in and test the new release. If everything looks good, then you can move forward to production environment.</p> <h2 id=promote-releases-to-production-environment>Promote Releases to Production Environment</h2> <p>If new release version received QA approval then the next step is to create a new pull request addressing changes for the production environment. Basically, you will change the <code>prod</code> overlay <code>kustomization.yaml</code> manifest file to reflect new release version of application images. Optionally (but recommended), a designated team member (usually the project manager) gives the final approval as part of the PR review process.</p> <p>Following diagram shows the high level overview of the process:</p> <pre class=mermaid><code>graph TD
A(New Application Release) --&gt; B{"Valid Release? &lt;br/&gt; #40;QA Approved#41;"}
B -- No --&gt; C(Reject Release)
B -- Yes --&gt; D(Promote to Prod PR)
D --&gt; E{Project Manager &lt;br/&gt; Approval}
E -- Yes --&gt; F(Deploy to Production Environment)
E -- No --&gt; C</code></pre> <p><strong>Prerequisites:</strong></p> <ol> <li>A new version release for your project. You already <a href=../setup-release-process/#releasing-a-new-version-for-the-online-boutique-application>released a new version</a> for the online boutique application in previous chapter, tagged with <code>v1.0.1</code>.</li> <li>Release artifacts already published to DOCR via the designated GitHub workflow. This step is already accomplished for <code>v1.0.1</code>, as mentioned above.</li> <li>New application version already tested and approved by QA team for staging environment.</li> </ol> <p><strong>Steps:</strong></p> <ol> <li> <p>Clone the <code>microservices-demo</code> repository on your local machine, if not already (make sure to replace the <code>&lt;&gt;</code> placeholders accordingly):</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-0-1 id=__codelineno-0-1 name=__codelineno-0-1></a>git clone https://github.com/&lt;YOUR_GITHUB_ACCOUNT_USERNAME&gt;/microservices-demo.git
</code></pre></div> </li> <li> <p>Change version number within <code>newTag</code> line for each application defined in the <code>kustomization.yaml</code> manifest file from <code>prod</code> overlay. For example, if new application version to promote is <code>v1.0.1</code>, then the <code>images</code> section looks similar to:</p> <details class=info> <summary>Click to expand the <code>kustomize/prod/kustomization.yaml</code> images section</summary> <div class=highlight><pre><span></span><code><a href=#__codelineno-1-1 id=__codelineno-1-1 name=__codelineno-1-1></a><span class=nn>...</span><span class=w></span>
<a href=#__codelineno-1-2 id=__codelineno-1-2 name=__codelineno-1-2></a><span class=nt>images</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-1-3 id=__codelineno-1-3 name=__codelineno-1-3></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cartservice</span><span class=w></span>
<a href=#__codelineno-1-4 id=__codelineno-1-4 name=__codelineno-1-4></a><span class=w>  </span><span class=nt>newName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">registry.digitalocean.com/microservices-demo/cartservice</span><span class=w></span>
<a href=#__codelineno-1-5 id=__codelineno-1-5 name=__codelineno-1-5></a><span class=hll><span class=w>  </span><span class=nt>newTag</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1.0.1</span><span class=w></span>
</span><a href=#__codelineno-1-6 id=__codelineno-1-6 name=__codelineno-1-6></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">checkoutservice</span><span class=w></span>
<a href=#__codelineno-1-7 id=__codelineno-1-7 name=__codelineno-1-7></a><span class=w>  </span><span class=nt>newName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">registry.digitalocean.com/microservices-demo/checkoutservice</span><span class=w></span>
<a href=#__codelineno-1-8 id=__codelineno-1-8 name=__codelineno-1-8></a><span class=hll><span class=w>  </span><span class=nt>newTag</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1.0.1</span><span class=w></span>
</span><a href=#__codelineno-1-9 id=__codelineno-1-9 name=__codelineno-1-9></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">currencyservice</span><span class=w></span>
<a href=#__codelineno-1-10 id=__codelineno-1-10 name=__codelineno-1-10></a><span class=w>  </span><span class=nt>newName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">registry.digitalocean.com/microservices-demo/currencyservice</span><span class=w></span>
<a href=#__codelineno-1-11 id=__codelineno-1-11 name=__codelineno-1-11></a><span class=hll><span class=w>  </span><span class=nt>newTag</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1.0.1</span><span class=w></span>
</span><a href=#__codelineno-1-12 id=__codelineno-1-12 name=__codelineno-1-12></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">emailservice</span><span class=w></span>
<a href=#__codelineno-1-13 id=__codelineno-1-13 name=__codelineno-1-13></a><span class=w>  </span><span class=nt>newName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">registry.digitalocean.com/microservices-demo/emailservice</span><span class=w></span>
<a href=#__codelineno-1-14 id=__codelineno-1-14 name=__codelineno-1-14></a><span class=hll><span class=w>  </span><span class=nt>newTag</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1.0.1</span><span class=w></span>
</span><a href=#__codelineno-1-15 id=__codelineno-1-15 name=__codelineno-1-15></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">frontend</span><span class=w></span>
<a href=#__codelineno-1-16 id=__codelineno-1-16 name=__codelineno-1-16></a><span class=w>  </span><span class=nt>newName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">registry.digitalocean.com/microservices-demo/frontend</span><span class=w></span>
<a href=#__codelineno-1-17 id=__codelineno-1-17 name=__codelineno-1-17></a><span class=hll><span class=w>  </span><span class=nt>newTag</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1.0.1</span><span class=w></span>
</span><a href=#__codelineno-1-18 id=__codelineno-1-18 name=__codelineno-1-18></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">paymentservice</span><span class=w></span>
<a href=#__codelineno-1-19 id=__codelineno-1-19 name=__codelineno-1-19></a><span class=w>  </span><span class=nt>newName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">registry.digitalocean.com/microservices-demo/paymentservice</span><span class=w></span>
<a href=#__codelineno-1-20 id=__codelineno-1-20 name=__codelineno-1-20></a><span class=hll><span class=w>  </span><span class=nt>newTag</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1.0.1</span><span class=w></span>
</span><a href=#__codelineno-1-21 id=__codelineno-1-21 name=__codelineno-1-21></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">productcatalogservice</span><span class=w></span>
<a href=#__codelineno-1-22 id=__codelineno-1-22 name=__codelineno-1-22></a><span class=w>  </span><span class=nt>newName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">registry.digitalocean.com/microservices-demo/productcatalogservice</span><span class=w></span>
<a href=#__codelineno-1-23 id=__codelineno-1-23 name=__codelineno-1-23></a><span class=hll><span class=w>  </span><span class=nt>newTag</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1.0.1</span><span class=w></span>
</span><a href=#__codelineno-1-24 id=__codelineno-1-24 name=__codelineno-1-24></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">recommendationservice</span><span class=w></span>
<a href=#__codelineno-1-25 id=__codelineno-1-25 name=__codelineno-1-25></a><span class=w>  </span><span class=nt>newName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">registry.digitalocean.com/microservices-demo/recommendationservice</span><span class=w></span>
<a href=#__codelineno-1-26 id=__codelineno-1-26 name=__codelineno-1-26></a><span class=hll><span class=w>  </span><span class=nt>newTag</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1.0.1</span><span class=w></span>
</span><a href=#__codelineno-1-27 id=__codelineno-1-27 name=__codelineno-1-27></a><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">shippingservice</span><span class=w></span>
<a href=#__codelineno-1-28 id=__codelineno-1-28 name=__codelineno-1-28></a><span class=w>  </span><span class=nt>newName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">registry.digitalocean.com/microservices-demo/shippingservice</span><span class=w></span>
<a href=#__codelineno-1-29 id=__codelineno-1-29 name=__codelineno-1-29></a><span class=hll><span class=w>  </span><span class=nt>newTag</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1.0.1</span><span class=w></span>
</span><a href=#__codelineno-1-30 id=__codelineno-1-30 name=__codelineno-1-30></a><span class=nn>...</span><span class=w></span>
</code></pre></div> </details> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Above example is using <strong>registry.digitalocean.com/microservices-demo</strong> for the DOCR endpoint. Don't forget to adjust according to your setup.</p> </div> </li> <li> <p>Save the <code>kustomization.yaml</code> manifest, commit changes to your working branch.</p> </li> <li>Push new branch to remote, and create a new PR addressing Kustomize changes for the <code>prod</code> overlay.</li> <li>Next, the <a href=../../05-ci-cd/setup-continuous-integration/#infrastructure-manifests-validation-github-workflow>Kustomize validation GitHub workflow</a> is automatically triggered.</li> <li>If all checks pass, approve the PR, and merge code to <code>main</code> branch.</li> </ol> <p>After a few moments (3 minutes max), ArgoCD picks changes and deploys new application version to <code>prod</code> environment. Finally, check if Argo CD synced the new application version to the production environment. After port-forwarding the Argo web console, you should see new application version deployed to your production environment automatically.</p> <h2 id=rollback-bad-releases>Rollback Bad Releases</h2> <p>A very important aspect of every CD system is the ability to easily rollback an application to a previous working version. On the other hand, you will want to perform the rollback in a timely manner as well to avoid unhappy clients, especially in production environments. Below you will find two methods that you can use. Both should work out of the box and yield the same result, the most notable difference being the speed at which you will perform the actual rollback.</p> <h3 id=github-pr-revert-feature>GitHub PR Revert Feature</h3> <p>In case something goes bad, you should be able to immediately revert the PR causing the culprit for the respective environment. Using PRs ensures atomic changes and rollbacks. Next, Argo CD picks the changes automatically and rolls back to previous application version.</p> <p>Essentially, you follow the same procedure as explained in the <a href=../../05-ci-cd/setup-continuous-deployments/#reverting-bad-application-deployments>reverting bad application deployments</a> section from the CD chapter. The big downside of this approach is that it is slower - you have to revert the previous PR, create a new one, wait for validation workflows to pass, manual review, and finally merge changes to main branch.</p> <p>Next, a faster approach is presented offered by Argo CD itself which suits best for production environments where speed matters.</p> <h3 id=argo-cd-application-rollback-feature>Argo CD Application Rollback Feature</h3> <p>Another approach is to use the <a href=https://argo-cd.readthedocs.io/en/stable/user-guide/commands/argocd_app_rollback/ >Argo CD application rollback</a> feature. You should be able to revert to any previous git commit ID. Using this approach you will perform faster application rollbacks.</p> <div class="admonition warning"> <p class=admonition-title>Warning</p> <p>Unfortunately there's an <a href=https://github.com/argoproj/argo-cd/issues/5351>open issue</a> on Argo CD project GitHub repository impeding the rollback feature from working properly. Nevertheless, below steps should give you a quick overview of how this operation is accomplished.</p> </div> <p>Follow below steps to learn how to use this feature:</p> <ol> <li> <p>Make sure kubectl context is set to point to your production environment cluster. Below example is using <code>do-nyc1-microservices-demo-production</code> for demonstration - make sure to change value if yours is different:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-2-1 id=__codelineno-2-1 name=__codelineno-2-1></a>kubectl config set-context <span class=k>do</span>-nyc1-microservices-demo-production
</code></pre></div> </li> <li> <p>Port forward the Argo CD web interface:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-3-1 id=__codelineno-3-1 name=__codelineno-3-1></a>kubectl port-forward -n argocd svc/argocd-server <span class=m>8080</span>:80
</code></pre></div> </li> <li> <p>Open the Argo CD dashboard in your web browser using <a href=https://localhost:8080/ >localhost:8080</a>.</p> </li> <li>Locate the <code>argocd/prod-microservices-demo</code> application tile, and click on it. You will be redirected to the <code>prod-microservices-demo</code> application details page.</li> <li> <p>Now, click on the <code>HISTORY AND ROLLBACK</code> button located at the top of the page:</p> <p><a class=glightbox data-desc-position=bottom data-description data-height=auto data-title data-width=100% href=../assets/images/promoting/app_history_rollback_btn.png><img alt="History And Rollback Nav" src=../assets/images/promoting/app_history_rollback_btn.png></a></p> </li> <li> <p>You should see a list of tiles representing deployment history activity for the <code>prod-microservices-demo</code> application. You need to scroll down to the second tile from the list, containing the previous release commit ID. Then, click on the three dots button from the right side - a <code>Rollback</code> button pops up:</p> <p><a class=glightbox data-desc-position=bottom data-description data-height=auto data-title data-width=100% href=../assets/images/promoting/app_rollback_tile.png><img alt="Rollback Tile" src=../assets/images/promoting/app_rollback_tile.png></a></p> </li> <li> <p>Click on the <code>Rollback</code> button. A dialog box message pops up informing you that the auto-sync feature needs to be turned off in order to finish the rollback operation. This is expected, otherwise Argo will immediately trigger an update if a change is detected in your GitOps repository and undo your rollback operation.</p> </li> <li>Click on the <code>OK</code> button, and wait for the process to finish.</li> </ol> <p>Just bear in mind that during the rollback process changes are performed only on the Argo CD server - your Git repository remains untouched. As a consequence, the affected Argo application is not in sync anymore with latest state of your Git repository. This is not a bad thing after all because it gives you time to fix the application. The affected Argo application will be synced again automatically after enabling auto-sync again, and a new release is made containing required fixes.</p> </article> </div> </div> </main> <footer class=md-footer> <nav aria-label=Footer class="md-footer__inner md-grid"> <a aria-label="Previous: Set up release process" class="md-footer__link md-footer__link--prev" href=../setup-release-process/ rel=prev> <div class="md-footer__button md-icon"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Set up release process </div> </div> </a> <a aria-label="Next: Securing the software supply chain" class="md-footer__link md-footer__link--next" href=../../07-security/software-supply-chain/ rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Securing the software supply chain </div> </div> <div class="md-footer__button md-icon"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> DigitalOcean </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ rel=noopener target=_blank> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../../assets/javascripts/bundle.d6c3db9e.min.js></script> <script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom"});})</script></body> </html>