<!DOCTYPE html><html class=no-js lang=en> <head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta content="Hands-on tutorial for going from day-1 to production on DigitalOcean Kubernetes." name=description><link href=https://digitalocean.github.io/k8s-adoption-journey/04-production/observability-production/ rel=canonical><link href=../../assets/images/favicon.png rel=icon><meta content="mkdocs-1.4.0, mkdocs-material-8.5.8" name=generator><title>Observability - Kubernetes Adoption Journey</title><link href=../../assets/stylesheets/main.20d9efc8.min.css rel=stylesheet><link href=../../assets/stylesheets/palette.815d1a91.min.css rel=stylesheet><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback" rel=stylesheet><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><link href=../../assets/stylesheets/glightbox.min.css rel=stylesheet><style>
            html.glightbox-open { overflow: initial; height: 100%; }
            .gdesc-inner { font-size: 0.75rem; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            
                .gscrollbar-fixer { padding-right: 15px; }
                </style><script src=../../assets/javascripts/glightbox.min.js></script></head> <body data-md-color-accent data-md-color-primary data-md-color-scheme=default dir=ltr> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input autocomplete=off class=md-toggle data-md-toggle=drawer id=__drawer type=checkbox> <input autocomplete=off class=md-toggle data-md-toggle=search id=__search type=checkbox> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a class=md-skip href=#introduction> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav aria-label=Header class="md-header__inner md-grid"> <a aria-label="Kubernetes Adoption Journey" class="md-header__button md-logo" data-md-component=logo href=../.. title="Kubernetes Adoption Journey"> <img alt=logo src=../../assets/do_logo.png> </a> <label class="md-header__button md-icon" for=__drawer> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Kubernetes Adoption Journey </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Observability </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input aria-label="Switch to dark mode" class=md-option data-md-color-accent data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary data-md-color-scheme=default id=__palette_1 name=__palette type=radio> <label class="md-header__button md-icon" for=__palette_2 hidden title="Switch to dark mode"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"></path></svg> </label> <input aria-label="Switch to light mode" class=md-option data-md-color-accent data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary data-md-color-scheme=slate id=__palette_2 name=__palette type=radio> <label class="md-header__button md-icon" for=__palette_1 hidden title="Switch to light mode"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M12 18a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-2.69L23.31 12 20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69Z"></path></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input aria-label=Search autocapitalize=off autocomplete=off autocorrect=off class=md-search__input data-md-component=search-query name=query placeholder=Search required spellcheck=false type=text> <label class="md-search__icon md-icon" for=__search> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg> </label> <nav aria-label=Search class=md-search__options> <button aria-label=Clear class="md-search__icon md-icon" tabindex=-1 title=Clear type=reset> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a class=md-source data-md-component=source href=https://github.com/digitalocean/k8s-adoption-journey title="Go to repository"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 448 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav aria-label=Navigation class="md-nav md-nav--primary" data-md-level=0> <label class=md-nav__title for=__drawer> <a aria-label="Kubernetes Adoption Journey" class="md-nav__button md-logo" data-md-component=logo href=../.. title="Kubernetes Adoption Journey"> <img alt=logo src=../../assets/do_logo.png> </a> Kubernetes Adoption Journey </label> <div class=md-nav__source> <a class=md-source data-md-component=source href=https://github.com/digitalocean/k8s-adoption-journey title="Go to repository"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 448 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a class=md-nav__link href=../..> Intro </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 id=__nav_2 type=checkbox> <label class=md-nav__link for=__nav_2> Getting started <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Getting started" class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Getting started </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../01-getting-started/installing-required-tools/ class=md-nav__link> Installing required tools </a> </li> <li class=md-nav__item> <a href=../../01-getting-started/do-api-auth/ class=md-nav__link> Authenticating with the DigitalOcean API </a> </li> <li class=md-nav__item> <a href=../../01-getting-started/setup-docr/ class=md-nav__link> Set up a Digital Ocean container registry </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_4 id=__nav_2_4 type=checkbox> <label class=md-nav__link for=__nav_2_4> Preparing the demo application <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Preparing the demo application" class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> Preparing the demo application </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../01-getting-started/building-and-pushing-docker-images/introduction-and-repository-setup/ class=md-nav__link> Repository setup </a> </li> <li class=md-nav__item> <a href=../../01-getting-started/building-and-pushing-docker-images/building-and-pushing-images-using-docker/ class=md-nav__link> Building and pushing images with Docker </a> </li> <li class=md-nav__item> <a href=../../01-getting-started/building-and-pushing-docker-images/building-and-pushing-images-using-cnb/ class=md-nav__link> Building and pushing images with Cloud Native Buildpacks </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 id=__nav_3 type=checkbox> <label class=md-nav__link for=__nav_3> Development environment <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Development environment" class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Development environment </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../02-development/setup-doks-dev/ class=md-nav__link> Set up Development DOKS </a> </li> <li class=md-nav__item> <a href=../../02-development/tilt-local/ class=md-nav__link> Tilt for local development </a> </li> <li class=md-nav__item> <a href=../../02-development/tilt-remote/ class=md-nav__link> Tilt for remote development </a> </li> <li class=md-nav__item> <a href=../../02-development/setup-ingress-dev/ class=md-nav__link> Set up ingress </a> </li> <li class=md-nav__item> <a href=../../02-development/observability-dev/ class=md-nav__link> Observability </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 id=__nav_4 type=checkbox> <label class=md-nav__link for=__nav_4> Staging environment <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Staging environment" class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Staging environment </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../03-staging/setup-doks-staging/ class=md-nav__link> Set up Staging DOKS </a> </li> <li class=md-nav__item> <a href=../../03-staging/deploying-the-online-boutique-sample-application-staging/ class=md-nav__link> Deploying the online boutique sample application </a> </li> <li class=md-nav__item> <a href=../../03-staging/setup-ingress-staging/ class=md-nav__link> Set up ingress </a> </li> <li class=md-nav__item> <a href=../../03-staging/observability-staging/ class=md-nav__link> Observability </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input checked class="md-nav__toggle md-toggle" data-md-toggle=__nav_5 id=__nav_5 type=checkbox> <label class=md-nav__link for=__nav_5> Production environment <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Production environment" class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Production environment </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../setup-doks-production/ class=md-nav__link> Set up Production DOKS </a> </li> <li class=md-nav__item> <a href=../deploying-the-online-boutique-sample-application-production/ class=md-nav__link> Deploying the online boutique sample application </a> </li> <li class=md-nav__item> <a href=../setup-ingress-production/ class=md-nav__link> Set up ingress </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc id=__toc type=checkbox> <label class="md-nav__link md-nav__link--active" for=__toc> Observability <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Observability </a> <nav aria-label="Table of contents" class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a class=md-nav__link href=#introduction> Introduction </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#prerequisites> Prerequisites </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#installing-the-prometheus-monitoring-stack> Installing the Prometheus Monitoring Stack </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#configuring-persistent-storage-for-prometheus> Configuring Persistent Storage for Prometheus </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#configuring-persistent-storage-for-grafana> Configuring Persistent Storage for Grafana </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#installing-the-loki-stack> Installing the Loki Stack </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#configuring-grafana-with-loki> Configuring Grafana with Loki </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#configuring-persistent-storage-for-loki> Configuring Persistent Storage for Loki </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#setting-up-a-retention-policy> Setting up a retention policy </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#setting-up-alert-manager> Setting up Alert Manager </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#configuring-alertmanager-to-send-notifications-to-slack> Configuring Alertmanager to Send Notifications to Slack </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#setting-up-event-exporter-for-events-retention> Setting up Event Exporter for events retention </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#viewing-events-in-grafana> Viewing events in Grafana </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6 id=__nav_6 type=checkbox> <label class=md-nav__link for=__nav_6> Continuous integration and deployments <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Continuous integration and deployments" class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Continuous integration and deployments </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../05-ci-cd/setup-continuous-integration/ class=md-nav__link> Set up continuous integration </a> </li> <li class=md-nav__item> <a href=../../05-ci-cd/setup-continuous-deployments/ class=md-nav__link> Set up continuous deployments </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_7 id=__nav_7 type=checkbox> <label class=md-nav__link for=__nav_7> Promote releases <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Promote releases" class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Promote releases </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../06-promote-releases/setup-release-process/ class=md-nav__link> Set up release process </a> </li> <li class=md-nav__item> <a href=../../06-promote-releases/promote-releases-to-upper-envs/ class=md-nav__link> Promote releases to upper environments </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_8 id=__nav_8 type=checkbox> <label class=md-nav__link for=__nav_8> Security <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Security class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> Security </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../07-security/software-supply-chain/ class=md-nav__link> Securing the software supply chain </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav aria-label="Table of contents" class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a class=md-nav__link href=#introduction> Introduction </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#prerequisites> Prerequisites </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#installing-the-prometheus-monitoring-stack> Installing the Prometheus Monitoring Stack </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#configuring-persistent-storage-for-prometheus> Configuring Persistent Storage for Prometheus </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#configuring-persistent-storage-for-grafana> Configuring Persistent Storage for Grafana </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#installing-the-loki-stack> Installing the Loki Stack </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#configuring-grafana-with-loki> Configuring Grafana with Loki </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#configuring-persistent-storage-for-loki> Configuring Persistent Storage for Loki </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#setting-up-a-retention-policy> Setting up a retention policy </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#setting-up-alert-manager> Setting up Alert Manager </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#configuring-alertmanager-to-send-notifications-to-slack> Configuring Alertmanager to Send Notifications to Slack </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#setting-up-event-exporter-for-events-retention> Setting up Event Exporter for events retention </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#viewing-events-in-grafana> Viewing events in Grafana </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a class="md-content__button md-icon" href=https://github.com/digitalocean/k8s-adoption-journey/edit/master/docs/04-production/observability-production.md title="Edit this page"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"></path></svg> </a> <h1>Observability</h1> <h2 id=introduction>Introduction</h2> <p>The goal of observability is to understand what’s happening across all of your environments and among the technologies, so you can detect and resolve issues to keep your systems efficient and reliable.</p> <p>Observability is a measure of how well the system’s internal states can be inferred from knowledge of its external outputs. It uses the data and insights that monitoring produces to provide a holistic understanding of your system, including its health and performance. The observability of your system, then, depends partly on how well your monitoring metrics can interpret your system's performance indicators.</p> <h2 id=prerequisites>Prerequisites</h2> <p>To complete this section you will need:</p> <ol> <li>Helm installed as explained in the <a href=../../01-getting-started/installing-required-tools/ >Installing required tools</a> section.</li> <li>A Kubernetes cluster (DOKS) up and running as explained in the <a href=../setup-doks-production/ >Set up DOKS</a> section.</li> <li>The online boutique sample application deployed to your cluster as explained in the <a href=../deploying-the-online-boutique-sample-application-production/ >Deploying the app</a> section.</li> <li>A <a href=https://cloud.digitalocean.com/spaces>DO Spaces</a> bucket for <code>Loki</code> storage. Please follow the official <code>DigitalOcean</code> tutorial to <a href=https://docs.digitalocean.com/products/spaces/how-to/create/ >create one</a>. Make sure that it is set to <code>restrict file listing</code> for security reasons.</li> </ol> <h2 id=installing-the-prometheus-monitoring-stack>Installing the Prometheus Monitoring Stack</h2> <ol> <li> <p>Add the <code>Helm</code> repository and list the available charts:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-0-1 id=__codelineno-0-1 name=__codelineno-0-1></a>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
<a href=#__codelineno-0-2 id=__codelineno-0-2 name=__codelineno-0-2></a>
<a href=#__codelineno-0-3 id=__codelineno-0-3 name=__codelineno-0-3></a>helm repo update prometheus-community
</code></pre></div> </li> <li> <p>Install the <code>kube-prometheus-stack</code>, using <code>Helm</code>:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-1-1 id=__codelineno-1-1 name=__codelineno-1-1></a><span class=nv>HELM_CHART_VERSION</span><span class=o>=</span><span class=s2>"35.5.1"</span>
<a href=#__codelineno-1-2 id=__codelineno-1-2 name=__codelineno-1-2></a>
<a href=#__codelineno-1-3 id=__codelineno-1-3 name=__codelineno-1-3></a>helm install kube-prom-stack prometheus-community/kube-prometheus-stack --version <span class=s2>"</span><span class=si>${</span><span class=nv>HELM_CHART_VERSION</span><span class=si>}</span><span class=s2>"</span> <span class=se>\</span>
<a href=#__codelineno-1-4 id=__codelineno-1-4 name=__codelineno-1-4></a>  --namespace monitoring <span class=se>\</span>
<a href=#__codelineno-1-5 id=__codelineno-1-5 name=__codelineno-1-5></a>  --create-namespace <span class=se>\</span>
<a href=#__codelineno-1-6 id=__codelineno-1-6 name=__codelineno-1-6></a>  -f <span class=s2>"docs/04-production/assets/manifests/prom-stack-values-v</span><span class=si>${</span><span class=nv>HELM_CHART_VERSION</span><span class=si>}</span><span class=s2>.yaml"</span>
</code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>A <code>specific</code> version for the <code>Helm</code> chart is used. In this case <code>35.5.1</code> was picked, which maps to the <code>0.56.3</code> version of the application. To check if the installation was successful, run the <code>helm ls -n monitoring</code> command, and confirm the deployment status.</p> </div> </li> <li> <p>Connect to <code>Grafana</code> (using default credentials: <code>admin/prom-operator</code>) - by port forwarding to local machine:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-2-1 id=__codelineno-2-1 name=__codelineno-2-1></a>kubectl --namespace monitoring port-forward svc/kube-prom-stack-grafana <span class=m>3000</span>:80
</code></pre></div> <div class="admonition info"> <p class=admonition-title>Info</p> <p>You should <strong>NOT</strong> expose <code>Grafana</code> to <code>public</code> network (eg. you should create an ingress mapping or <code>LB</code> service).</p> </div> </li> <li> <p>Open a web browser and point to <a href=http://localhost:3000>localhost:3000</a>. You should see the <code>Grafna</code> login page.</p> <div class="admonition info"> <p class=admonition-title>Info</p> <p><code>Grafana</code> installation comes with a number of dashboards. Open a web browser on <a href=http://localhost:3000>localhost:3000</a>. Once in, you can go to <code>Dashboards -&gt; Browse</code>, and choose different dashboards. As an example, you can open the <code>General / Kubernetes / Compute Resources / Node (Pods)</code> and view the resource metrics for a node and its related pods. <a class=glightbox data-desc-position=bottom data-description data-height=auto data-title data-width=100% href=../../assets/grafana_dashboard_example.png><img alt="grafana dashboard example" src=../../assets/grafana_dashboard_example.png></a></p> </div> </li> </ol> <h2 id=configuring-persistent-storage-for-prometheus>Configuring Persistent Storage for Prometheus</h2> <p>In this section, you will learn how to enable <code>persistent storage</code> for <code>Prometheus</code>, so that metrics data is persisted across <code>server restarts</code>, or in case of <code>cluster failures</code>. For the <code>production</code> environment, you will define a <code>10 Gi Persistent Volume Claim</code> (PVC), using the <code>DigitalOcean Block Storage</code>.</p> <ol> <li> <p>Open the <code>"docs/04-production/assets/manifests/prom-stack-values-v35.5.1.yaml</code> file provided and uncomment the <code>storageSpec</code> section. The definition should look like this:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-3-1 id=__codelineno-3-1 name=__codelineno-3-1></a><span class=nt>prometheusSpec</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-3-2 id=__codelineno-3-2 name=__codelineno-3-2></a><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class=w></span>
<a href=#__codelineno-3-3 id=__codelineno-3-3 name=__codelineno-3-3></a><span class=w>  </span><span class=nt>retention</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">20</span><span class=w></span>
<a href=#__codelineno-3-4 id=__codelineno-3-4 name=__codelineno-3-4></a><span class=w>  </span><span class=nt>storageSpec</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-3-5 id=__codelineno-3-5 name=__codelineno-3-5></a><span class=w>    </span><span class=nt>volumeClaimTemplate</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-3-6 id=__codelineno-3-6 name=__codelineno-3-6></a><span class=w>      </span><span class=nt>spec</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-3-7 id=__codelineno-3-7 name=__codelineno-3-7></a><span class=w>        </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">do-block-storage</span><span class=w></span>
<a href=#__codelineno-3-8 id=__codelineno-3-8 name=__codelineno-3-8></a><span class=w>        </span><span class=nt>accessModes</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>"ReadWriteOnce"</span><span class="p p-Indicator">]</span><span class=w></span>
<a href=#__codelineno-3-9 id=__codelineno-3-9 name=__codelineno-3-9></a><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-3-10 id=__codelineno-3-10 name=__codelineno-3-10></a><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-3-11 id=__codelineno-3-11 name=__codelineno-3-11></a><span class=w>            </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10Gi</span><span class=w></span>
</code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>The default retention time for metrics is set to <code>10d</code> by default in the <code>kube-prometheus-stack</code> helm chart. In production the retention time will be set to <code>20d</code>. After 20 days the metrics will be deleted from the <code>Volume</code>.</p> </div> </li> <li> <p>Apply the new settings using <code>Helm</code>:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-4-1 id=__codelineno-4-1 name=__codelineno-4-1></a><span class=nv>HELM_CHART_VERSION</span><span class=o>=</span><span class=s2>"35.5.1"</span>
<a href=#__codelineno-4-2 id=__codelineno-4-2 name=__codelineno-4-2></a>
<a href=#__codelineno-4-3 id=__codelineno-4-3 name=__codelineno-4-3></a>helm upgrade kube-prom-stack prometheus-community/kube-prometheus-stack --version <span class=s2>"</span><span class=si>${</span><span class=nv>HELM_CHART_VERSION</span><span class=si>}</span><span class=s2>"</span> <span class=se>\</span>
<a href=#__codelineno-4-4 id=__codelineno-4-4 name=__codelineno-4-4></a>  --namespace monitoring <span class=se>\</span>
<a href=#__codelineno-4-5 id=__codelineno-4-5 name=__codelineno-4-5></a>  -f <span class=s2>"docs/04-production/assets/manifests/prom-stack-values-v</span><span class=si>${</span><span class=nv>HELM_CHART_VERSION</span><span class=si>}</span><span class=s2>.yaml"</span>
</code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Check the <code>PVC</code> status by running <code>kubectl get pvc -n monitoring</code>. A new <code>Volume</code> should appear in the <a href=https://cloud.digitalocean.com/volumes>Volumes</a> web page, from your <code>DigitalOcean</code> account panel.</p> </div> </li> </ol> <h2 id=configuring-persistent-storage-for-grafana>Configuring Persistent Storage for Grafana</h2> <p>In this section, you will learn how to enable <code>persistent storage</code> for <code>Grafana</code>, so that metrics data is persisted across <code>server restarts</code>, or in case of <code>cluster failures</code>. For the <code>production</code> environment, you will define a <code>10 Gi Persistent Volume Claim</code> (PVC), using the <code>DigitalOcean Block Storage</code>.</p> <ol> <li> <p>Open the <code>docs/04-production/assets/manifests/prom-stack-values-v35.5.1.yaml</code> file provided and uncomment the <code>storageSpec</code> section. The definition should look like this:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-5-1 id=__codelineno-5-1 name=__codelineno-5-1></a><span class=nt>grafana</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-5-2 id=__codelineno-5-2 name=__codelineno-5-2></a><span class=nn>...</span><span class=w></span>
<a href=#__codelineno-5-3 id=__codelineno-5-3 name=__codelineno-5-3></a><span class=nt>persistence</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-5-4 id=__codelineno-5-4 name=__codelineno-5-4></a><span class=w>    </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w></span>
<a href=#__codelineno-5-5 id=__codelineno-5-5 name=__codelineno-5-5></a><span class=w>    </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">do-block-storage</span><span class=w></span>
<a href=#__codelineno-5-6 id=__codelineno-5-6 name=__codelineno-5-6></a><span class=w>    </span><span class=nt>accessModes</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>"ReadWriteOnce"</span><span class="p p-Indicator">]</span><span class=w></span>
<a href=#__codelineno-5-7 id=__codelineno-5-7 name=__codelineno-5-7></a><span class=w>    </span><span class=nt>size</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10Gi</span><span class=w></span>
</code></pre></div> </li> <li> <p>Apply the new settings using <code>Helm</code>:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-6-1 id=__codelineno-6-1 name=__codelineno-6-1></a><span class=nv>HELM_CHART_VERSION</span><span class=o>=</span><span class=s2>"35.5.1"</span>
<a href=#__codelineno-6-2 id=__codelineno-6-2 name=__codelineno-6-2></a>
<a href=#__codelineno-6-3 id=__codelineno-6-3 name=__codelineno-6-3></a>helm upgrade kube-prom-stack prometheus-community/kube-prometheus-stack --version <span class=s2>"</span><span class=si>${</span><span class=nv>HELM_CHART_VERSION</span><span class=si>}</span><span class=s2>"</span> <span class=se>\</span>
<a href=#__codelineno-6-4 id=__codelineno-6-4 name=__codelineno-6-4></a>  --namespace monitoring <span class=se>\</span>
<a href=#__codelineno-6-5 id=__codelineno-6-5 name=__codelineno-6-5></a>  -f <span class=s2>"docs/04-production/assets/manifests/prom-stack-values-v</span><span class=si>${</span><span class=nv>HELM_CHART_VERSION</span><span class=si>}</span><span class=s2>.yaml"</span>
</code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Check the <code>PVC</code> status by running <code>kubectl get pvc -n monitoring</code>. A new <code>Volume</code> should appear in the <a href=https://cloud.digitalocean.com/volumes>Volumes</a> web page, from your <code>DigitalOcean</code> account panel.</p> </div> </li> </ol> <h2 id=installing-the-loki-stack>Installing the Loki Stack</h2> <p>In this section you will learn about <a href=https://github.com/grafana/helm-charts/tree/main/charts/loki-stack>Loki</a>, which is a log <code>aggregation</code> system inspired by <code>Prometheus</code>. <code>Loki</code> uses <code>Promtail</code> to fetch logs from all <code>Pods</code> running in your cluster. Then, logs are <code>aggregated</code> and <code>compressed</code>, and sent to the configured <code>storage</code>. Next, you can connect <code>Loki</code> data source to <code>Grafana</code> and view the logs.</p> <ol> <li> <p>Add the <code>Grafana</code> Helm repository and list the available charts:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-7-1 id=__codelineno-7-1 name=__codelineno-7-1></a>helm repo add grafana https://grafana.github.io/helm-charts
<a href=#__codelineno-7-2 id=__codelineno-7-2 name=__codelineno-7-2></a>
<a href=#__codelineno-7-3 id=__codelineno-7-3 name=__codelineno-7-3></a>helm repo update grafana
</code></pre></div> </li> <li> <p>Intall the <code>Loki</code> stack using <code>Helm</code>:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-8-1 id=__codelineno-8-1 name=__codelineno-8-1></a>    <span class=nv>HELM_CHART_VERSION</span><span class=o>=</span><span class=s2>"2.6.4"</span>
<a href=#__codelineno-8-2 id=__codelineno-8-2 name=__codelineno-8-2></a>
<a href=#__codelineno-8-3 id=__codelineno-8-3 name=__codelineno-8-3></a>    helm install loki grafana/loki-stack --version <span class=s2>"</span><span class=si>${</span><span class=nv>HELM_CHART_VERSION</span><span class=si>}</span><span class=s2>"</span> <span class=se>\</span>
<a href=#__codelineno-8-4 id=__codelineno-8-4 name=__codelineno-8-4></a>    --namespace<span class=o>=</span>loki-stack <span class=se>\</span>
<a href=#__codelineno-8-5 id=__codelineno-8-5 name=__codelineno-8-5></a>    --create-namespace <span class=se>\</span>
<a href=#__codelineno-8-6 id=__codelineno-8-6 name=__codelineno-8-6></a>    -f <span class=s2>"docs/04-production/assets/manifests/loki-stack-values-v</span><span class=si>${</span><span class=nv>HELM_CHART_VERSION</span><span class=si>}</span><span class=s2>.yaml"</span>
</code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>The above values file, enables <code>Loki</code> and <code>Promtail</code> for you, so no other input is required. <code>Prometheus</code> and <code>Grafana</code> installation is disabled, because <a href=#installing-the-prometheus-monitoring-stack>Installing the Prometheus Monitoring Stack</a> took care of it already. The <code>2.6.4</code> Helm chart version is picked for <code>loki-stack</code>, which maps to application version <code>2.4.2</code>. To check if the installation was successful, run the <code>helm ls -n loki-stack</code> command, and confirm the deployment status.</p> </div> </li> </ol> <h2 id=configuring-grafana-with-loki>Configuring Grafana with Loki</h2> <p>In this section, you will add the <code>Loki</code> data source to <code>Grafana</code>. First, you need to expose the <code>Grafana</code> web interface on your local machine (default credentials: <code>admin/prom-operator</code>):</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-9-1 id=__codelineno-9-1 name=__codelineno-9-1></a>kubectl --namespace monitoring port-forward svc/kube-prom-stack-grafana <span class=m>3000</span>:80
</code></pre></div> <p>Next, open a web browser on <a href=http://localhost:3000>localhost:3000</a>, and follow below steps:</p> <ol> <li>Click the <code>Configuration</code> gear from the left panel.</li> <li>Select <code>Data sources</code>.</li> <li>Click the <code>Add data source</code> blue button.</li> <li>Select <code>Loki</code> from the list and add <code>Loki</code> url <code>http://loki.loki-stack:3100</code>.</li> <li>Save and test.</li> </ol> <div class="admonition info"> <p class=admonition-title>Info</p> <p>If everything goes well, a green label message will appear, saying <code>Data source connected and labels found.</code></p> </div> <p>You can access logs from the <code>Explore</code> tab of <code>Grafana</code>. Make sure to select <code>Loki</code> as the data source. Use the <code>Help</code> button for log search cheat sheet. !!! info As an example query, to retrieve all the logs for the <code>microservices-demo-prod</code> namespace you can run: <code>{namespace="microservices-demo-prod"}</code>.</p> <h2 id=configuring-persistent-storage-for-loki>Configuring Persistent Storage for Loki</h2> <p>In this step, you will learn how to enable <code>persistent</code> storage for <code>Loki</code>. You're going to use the <code>DO Spaces</code> bucket created in the <a href=#prerequisites>Prerequisites</a> section.</p> <ol> <li> <p>Open the <code>docs/04-production/assets/manifests/loki-stack-values-v35.5.1.yaml</code> file provided and remove the comments surrounding the <code>schema_config</code> and <code>storage_config</code> keys. The definition should look like this:</p> <details class=note> <summary>Click to expand the <code>loki config</code></summary> <div class=highlight><pre><span></span><code><a href=#__codelineno-10-1 id=__codelineno-10-1 name=__codelineno-10-1></a><span class=nt>loki</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-10-2 id=__codelineno-10-2 name=__codelineno-10-2></a><span class=w>    </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w></span>
<a href=#__codelineno-10-3 id=__codelineno-10-3 name=__codelineno-10-3></a><span class=w>    </span><span class=nt>config</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-10-4 id=__codelineno-10-4 name=__codelineno-10-4></a><span class=w>    </span><span class=nt>schema_config</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-10-5 id=__codelineno-10-5 name=__codelineno-10-5></a><span class=w>        </span><span class=nt>configs</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-10-6 id=__codelineno-10-6 name=__codelineno-10-6></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>from</span><span class=p>:</span><span class=w> </span><span class=s>"2020-10-24"</span><span class=w></span>
<a href=#__codelineno-10-7 id=__codelineno-10-7 name=__codelineno-10-7></a><span class=w>            </span><span class=nt>store</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">boltdb-shipper</span><span class=w></span>
<a href=#__codelineno-10-8 id=__codelineno-10-8 name=__codelineno-10-8></a><span class=w>            </span><span class=nt>object_store</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">aws</span><span class=w></span>
<a href=#__codelineno-10-9 id=__codelineno-10-9 name=__codelineno-10-9></a><span class=w>            </span><span class=nt>schema</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v11</span><span class=w></span>
<a href=#__codelineno-10-10 id=__codelineno-10-10 name=__codelineno-10-10></a><span class=w>            </span><span class=nt>index</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-10-11 id=__codelineno-10-11 name=__codelineno-10-11></a><span class=w>            </span><span class=nt>prefix</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">index_</span><span class=w></span>
<a href=#__codelineno-10-12 id=__codelineno-10-12 name=__codelineno-10-12></a><span class=w>            </span><span class=nt>period</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">24h</span><span class=w></span>
<a href=#__codelineno-10-13 id=__codelineno-10-13 name=__codelineno-10-13></a><span class=w>    </span><span class=nt>storage_config</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-10-14 id=__codelineno-10-14 name=__codelineno-10-14></a><span class=w>    </span><span class=nt>boltdb_shipper</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-10-15 id=__codelineno-10-15 name=__codelineno-10-15></a><span class=w>        </span><span class=nt>active_index_directory</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/data/loki/boltdb-shipper-active</span><span class=w></span>
<a href=#__codelineno-10-16 id=__codelineno-10-16 name=__codelineno-10-16></a><span class=w>        </span><span class=nt>cache_location</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/data/loki/boltdb-shipper-cache</span><span class=w></span>
<a href=#__codelineno-10-17 id=__codelineno-10-17 name=__codelineno-10-17></a><span class=w>        </span><span class=nt>cache_ttl</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">24h</span><span class=w></span>
<a href=#__codelineno-10-18 id=__codelineno-10-18 name=__codelineno-10-18></a><span class=w>        </span><span class=nt>shared_store</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">aws</span><span class=w></span>
<a href=#__codelineno-10-19 id=__codelineno-10-19 name=__codelineno-10-19></a><span class=w>    </span><span class=nt>aws</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-10-20 id=__codelineno-10-20 name=__codelineno-10-20></a><span class=w>        </span><span class=nt>bucketnames</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">&lt;YOUR_DO_SPACES_BUCKET_NAME_HERE&gt;</span><span class=w></span>
<a href=#__codelineno-10-21 id=__codelineno-10-21 name=__codelineno-10-21></a><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">&lt;YOUR_DO_SPACES_BUCKET_ENDPOINT_HERE&gt;</span><span class=w>  </span><span class=c1># in the following format: &lt;region&gt;.digitaloceanspaces.com</span><span class=w></span>
<a href=#__codelineno-10-22 id=__codelineno-10-22 name=__codelineno-10-22></a><span class=w>        </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">&lt;YOUR_DO_SPACES_BUCKET_REGION_HERE&gt;</span><span class=w>      </span><span class=c1># short region name (e.g.: fra1)</span><span class=w></span>
<a href=#__codelineno-10-23 id=__codelineno-10-23 name=__codelineno-10-23></a><span class=w>        </span><span class=nt>access_key_id</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">&lt;YOUR_DO_SPACES_ACCESS_KEY_HERE&gt;</span><span class=w></span>
<a href=#__codelineno-10-24 id=__codelineno-10-24 name=__codelineno-10-24></a><span class=w>        </span><span class=nt>secret_access_key</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">&lt;YOURDO_SPACES_SECRET_KEY_HERE&gt;</span><span class=w></span>
<a href=#__codelineno-10-25 id=__codelineno-10-25 name=__codelineno-10-25></a><span class=w>        </span><span class=nt>s3forcepathstyle</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w></span>
</code></pre></div> </details> </li> <li> <p>Apply the new settings using <code>Helm</code>:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-11-1 id=__codelineno-11-1 name=__codelineno-11-1></a>    <span class=nv>HELM_CHART_VERSION</span><span class=o>=</span><span class=s2>"2.6.4"</span>
<a href=#__codelineno-11-2 id=__codelineno-11-2 name=__codelineno-11-2></a>
<a href=#__codelineno-11-3 id=__codelineno-11-3 name=__codelineno-11-3></a>    helm upgrade loki grafana/loki-stack --version <span class=s2>"</span><span class=si>${</span><span class=nv>HELM_CHART_VERSION</span><span class=si>}</span><span class=s2>"</span> <span class=se>\</span>
<a href=#__codelineno-11-4 id=__codelineno-11-4 name=__codelineno-11-4></a>    --namespace<span class=o>=</span>loki-stack <span class=se>\</span>
<a href=#__codelineno-11-5 id=__codelineno-11-5 name=__codelineno-11-5></a>    -f <span class=s2>"docs/04-production/assets/manifests/loki-stack-values-v</span><span class=si>${</span><span class=nv>HELM_CHART_VERSION</span><span class=si>}</span><span class=s2>.yaml"</span>
</code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Check if the main <code>Loki</code> application pod is up and running by runnging the following <code>kubectl</code> command: <code>kubectl get pods -n loki-stack -l app=loki</code>. If everything goes well, you should see the <code>DO Spaces</code> bucket containing the <code>index</code> and <code>chunks</code> folders (the <code>chunks</code> folder is called <code>fake</code>, which is a strange name - this is by design, when not running in <code>multi-tenant</code> mode).</p> </div> </li> </ol> <h2 id=setting-up-a-retention-policy>Setting up a retention policy</h2> <p>In this step you will set up a retention policy for your <code>DO Spaces</code> bucket. <code>S3CMD</code> is a good utility to have in order to set up retention policies. Please follow the <code>DigitalOcean</code> guide for installing and setting up <a href=https://docs.digitalocean.com/products/spaces/resources/s3cmd>s3cmd</a>.</p> <ol> <li> <p>Configure the <code>Loki</code> bucket lifecycle, using <code>s3cmd</code>:</p> <details class=note> <summary>Click to expand the <code>Loki bucket lifecycle</code></summary> <div class=highlight><pre><span></span><code><a href=#__codelineno-12-1 id=__codelineno-12-1 name=__codelineno-12-1></a><span class=nt>&lt;LifecycleConfiguration</span> <span class=na>xmlns=</span><span class=s>"http://s3.amazonaws.com/doc/2006-03-01/"</span><span class=nt>&gt;</span>
<a href=#__codelineno-12-2 id=__codelineno-12-2 name=__codelineno-12-2></a><span class=nt>&lt;Rule&gt;</span>
<a href=#__codelineno-12-3 id=__codelineno-12-3 name=__codelineno-12-3></a>    <span class=nt>&lt;ID&gt;</span>Expire old fake data<span class=nt>&lt;/ID&gt;</span>
<a href=#__codelineno-12-4 id=__codelineno-12-4 name=__codelineno-12-4></a>    <span class=nt>&lt;Prefix&gt;</span>fake/<span class=nt>&lt;/Prefix&gt;</span>
<a href=#__codelineno-12-5 id=__codelineno-12-5 name=__codelineno-12-5></a>    <span class=nt>&lt;Status&gt;</span>Enabled<span class=nt>&lt;/Status&gt;</span>
<a href=#__codelineno-12-6 id=__codelineno-12-6 name=__codelineno-12-6></a>    <span class=nt>&lt;Expiration&gt;</span>
<a href=#__codelineno-12-7 id=__codelineno-12-7 name=__codelineno-12-7></a>    <span class=nt>&lt;Days&gt;</span>10<span class=nt>&lt;/Days&gt;</span>
<a href=#__codelineno-12-8 id=__codelineno-12-8 name=__codelineno-12-8></a>    <span class=nt>&lt;/Expiration&gt;</span>
<a href=#__codelineno-12-9 id=__codelineno-12-9 name=__codelineno-12-9></a><span class=nt>&lt;/Rule&gt;</span>
<a href=#__codelineno-12-10 id=__codelineno-12-10 name=__codelineno-12-10></a>
<a href=#__codelineno-12-11 id=__codelineno-12-11 name=__codelineno-12-11></a><span class=nt>&lt;Rule&gt;</span>
<a href=#__codelineno-12-12 id=__codelineno-12-12 name=__codelineno-12-12></a>    <span class=nt>&lt;ID&gt;</span>Expire old index data<span class=nt>&lt;/ID&gt;</span>
<a href=#__codelineno-12-13 id=__codelineno-12-13 name=__codelineno-12-13></a>    <span class=nt>&lt;Prefix&gt;</span>index/<span class=nt>&lt;/Prefix&gt;</span>
<a href=#__codelineno-12-14 id=__codelineno-12-14 name=__codelineno-12-14></a>    <span class=nt>&lt;Status&gt;</span>Enabled<span class=nt>&lt;/Status&gt;</span>
<a href=#__codelineno-12-15 id=__codelineno-12-15 name=__codelineno-12-15></a>    <span class=nt>&lt;Expiration&gt;</span>
<a href=#__codelineno-12-16 id=__codelineno-12-16 name=__codelineno-12-16></a>    <span class=nt>&lt;Days&gt;</span>10<span class=nt>&lt;/Days&gt;</span>
<a href=#__codelineno-12-17 id=__codelineno-12-17 name=__codelineno-12-17></a>    <span class=nt>&lt;/Expiration&gt;</span>
<a href=#__codelineno-12-18 id=__codelineno-12-18 name=__codelineno-12-18></a><span class=nt>&lt;/Rule&gt;</span>
<a href=#__codelineno-12-19 id=__codelineno-12-19 name=__codelineno-12-19></a><span class=nt>&lt;/LifecycleConfiguration&gt;</span>
</code></pre></div> </details> <div class=highlight><pre><span></span><code><a href=#__codelineno-13-1 id=__codelineno-13-1 name=__codelineno-13-1></a>s3cmd setlifecycle <span class=m>04</span>-setup-observability/assets/manifests/loki_do_spaces_lifecycle.xml s3://&lt;LOKI_STORAGE_BUCKET_NAME&gt;
</code></pre></div> </li> <li> <p>Check that the <code>policy</code> was set (please replace the <code>&lt;&gt;</code> placeholders accordingly):</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-14-1 id=__codelineno-14-1 name=__codelineno-14-1></a>s3cmd getlifecycle s3://&lt;LOKI_STORAGE_BUCKET_NAME&gt;
</code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>The <code>DO Spaces</code> backend implementation will clean the objects for you <code>automatically</code>, based on the expiration date. You can always go back and edit the policy if needed later on, by uploading a new one.</p> </div> </li> </ol> <h2 id=setting-up-alert-manager>Setting up Alert Manager</h2> <p>Alertmanager is deployed alongside Prometheus and forms the alerting layer of the <code>kube-prom-stack</code>. It handles alerts generated by Prometheus by deduplicating, grouping, and routing them to various integrations such as email, Slack or PagerDuty. Alerts and notifications are a critical part of your workflow. When things go wrong (e.g. any service is down, or a pod is crashing, etc.), you will want to get notifications in real time to handle critical situations as soon as possible.</p> <p>To create a new alert, you need to add a new definition in the <code>additionalPrometheusRule</code>s section from the kube-prom-stack Helm values file. You will be creating a sample alert that will trigger if the <code>microservices-demo-prod</code> namespace does not have an expected number of instances. The expected number of pods for the <code>online boutique</code> application is 10.</p> <ol> <li> <p>Open the <code>docs/04-production/assets/manifests/prom-stack-values-v35.5.1.yaml</code> file provided and uncomment the <code>additionalPrometheusRulesMap</code> block. The definition should look like this:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-15-1 id=__codelineno-15-1 name=__codelineno-15-1></a><span class=nt>additionalPrometheusRulesMap</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-15-2 id=__codelineno-15-2 name=__codelineno-15-2></a><span class=w>  </span><span class=nt>rule-name</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-15-3 id=__codelineno-15-3 name=__codelineno-15-3></a><span class=w>    </span><span class=nt>groups</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-15-4 id=__codelineno-15-4 name=__codelineno-15-4></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">online-boutique-instance-down</span><span class=w></span>
<a href=#__codelineno-15-5 id=__codelineno-15-5 name=__codelineno-15-5></a><span class=w>      </span><span class=nt>rules</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-15-6 id=__codelineno-15-6 name=__codelineno-15-6></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>alert</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">OnlineBoutiqueInstanceDown</span><span class=w></span>
<a href=#__codelineno-15-7 id=__codelineno-15-7 name=__codelineno-15-7></a><span class=w>          </span><span class=nt>expr</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">sum(kube_pod_owner{namespace="microservices-demo-prod"}) by (namespace) &lt; 10</span><span class=w></span>
<a href=#__codelineno-15-8 id=__codelineno-15-8 name=__codelineno-15-8></a><span class=w>          </span><span class=nt>for</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1m</span><span class=w></span>
<a href=#__codelineno-15-9 id=__codelineno-15-9 name=__codelineno-15-9></a><span class=w>          </span><span class=nt>labels</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-15-10 id=__codelineno-15-10 name=__codelineno-15-10></a><span class=w>            </span><span class=nt>severity</span><span class=p>:</span><span class=w> </span><span class=s>'critical'</span><span class=w></span>
<a href=#__codelineno-15-11 id=__codelineno-15-11 name=__codelineno-15-11></a><span class=w>          </span><span class=nt>annotations</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-15-12 id=__codelineno-15-12 name=__codelineno-15-12></a><span class=w>            </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s>'</span><span class=nv> </span><span class=s>The</span><span class=nv> </span><span class=s>Number</span><span class=nv> </span><span class=s>of</span><span class=nv> </span><span class=s>pods</span><span class=nv> </span><span class=s>from</span><span class=nv> </span><span class=s>the</span><span class=nv> </span><span class=s>namespace</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>$labels.namespace</span><span class=nv> </span><span class=s>}}</span><span class=nv> </span><span class=s>is</span><span class=nv> </span><span class=s>lower</span><span class=nv> </span><span class=s>than</span><span class=nv> </span><span class=s>the</span><span class=nv> </span><span class=s>expected</span><span class=nv> </span><span class=s>10.</span><span class=nv> </span><span class=s>'</span><span class=w></span>
<a href=#__codelineno-15-13 id=__codelineno-15-13 name=__codelineno-15-13></a><span class=w>            </span><span class=nt>summary</span><span class=p>:</span><span class=w> </span><span class=s>'Pod</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>$labels.pod</span><span class=nv> </span><span class=s>}}</span><span class=nv> </span><span class=s>down'</span><span class=w></span>
</code></pre></div> </li> <li> <p>Apply the new settings using <code>Helm</code>:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-16-1 id=__codelineno-16-1 name=__codelineno-16-1></a><span class=nv>HELM_CHART_VERSION</span><span class=o>=</span><span class=s2>"35.5.1"</span>
<a href=#__codelineno-16-2 id=__codelineno-16-2 name=__codelineno-16-2></a>
<a href=#__codelineno-16-3 id=__codelineno-16-3 name=__codelineno-16-3></a>helm upgrade kube-prom-stack prometheus-community/kube-prometheus-stack --version <span class=s2>"</span><span class=si>${</span><span class=nv>HELM_CHART_VERSION</span><span class=si>}</span><span class=s2>"</span> <span class=se>\</span>
<a href=#__codelineno-16-4 id=__codelineno-16-4 name=__codelineno-16-4></a>  --namespace monitoring <span class=se>\</span>
<a href=#__codelineno-16-5 id=__codelineno-16-5 name=__codelineno-16-5></a>  -f <span class=s2>"docs/04-production/assets/manifests/prom-stack-values-v</span><span class=si>${</span><span class=nv>HELM_CHART_VERSION</span><span class=si>}</span><span class=s2>.yaml"</span>
</code></pre></div> <div class="admonition info"> <p class=admonition-title>Info</p> <p>To check that the alert has been created successfully, first port-forward to your local machine by running this command: <code>kubectl --namespace monitoring port-forward service/kube-prom-stack-kube-prome-prometheus 9090:9090</code>. Navigate to the <a href=http://localhost:9090>Promethes Console</a> click on the <code>Alerts</code> menu item and identify the <code>OnlineBoutiqueInstanceDown</code> alert. It should be visible at the bottom of the list.</p> </div> </li> </ol> <h2 id=configuring-alertmanager-to-send-notifications-to-slack>Configuring Alertmanager to Send Notifications to Slack</h2> <p>To complete this section you need to have administrative rights over a workspace. This will enable you to create the incoming webhook you will need in the next steps. You will also need to create a channel where you would like to receive notifications from <code>AlertManager</code>.</p> <p>Steps to follow:</p> <ol> <li>Open a web browser and navigate to <code>https://api.slack.com/apps</code> and click on the <code>Create New App</code> button.</li> <li>In the <code>Create an app</code> window select the <code>From scratch</code> option. Then, give your application a name and select the appropriate workspace.</li> <li>From the <code>Basic Information</code> page click on the <code>Incoming Webhooks</code> option, turn it on and click on the <code>Add New Webhook to Workspace</code> button at the bottom.</li> <li>On the next page, use the <code>Search for a channel...</code> drop-down list to select the desired channel where you want to send notifications. When ready, click on the <code>Allow</code> button.</li> <li>Take note of the <code>Webhook URL</code> value displayed on the page. You will be using it in the next section.</li> </ol> <p>Next you will tell <code>Alertmanager</code> how to send <code>Slack</code> notifications.</p> <ol> <li> <p>Open the <code>docs/04-production/assets/manifests/prom-stack-values-v35.5.1.yaml</code> file provided and uncomment the <code>alertmaanager.config</code> block. Make sure to update the <code>&lt;&gt;</code> placeholders accordingly. The definition should look like:</p> <details class=note> <summary>Click to expand the <code>alertmanager config</code></summary> <div class=highlight><pre><span></span><code><a href=#__codelineno-17-1 id=__codelineno-17-1 name=__codelineno-17-1></a><span class=nt>alertmanager</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-17-2 id=__codelineno-17-2 name=__codelineno-17-2></a><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w></span>
<a href=#__codelineno-17-3 id=__codelineno-17-3 name=__codelineno-17-3></a><span class=nt>config</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-17-4 id=__codelineno-17-4 name=__codelineno-17-4></a><span class=w>    </span><span class=nt>global</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-17-5 id=__codelineno-17-5 name=__codelineno-17-5></a><span class=w>    </span><span class=nt>resolve_timeout</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5m</span><span class=w></span>
<a href=#__codelineno-17-6 id=__codelineno-17-6 name=__codelineno-17-6></a><span class=w>    </span><span class=nt>slack_api_url</span><span class=p>:</span><span class=w> </span><span class=s>"&lt;YOUR_SLACK_APP_INCOMING_WEBHOOK_URL_HERE&gt;"</span><span class=w></span>
<a href=#__codelineno-17-7 id=__codelineno-17-7 name=__codelineno-17-7></a><span class=w>    </span><span class=nt>route</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-17-8 id=__codelineno-17-8 name=__codelineno-17-8></a><span class=w>    </span><span class=nt>receiver</span><span class=p>:</span><span class=w> </span><span class=s>"null"</span><span class=w></span>
<a href=#__codelineno-17-9 id=__codelineno-17-9 name=__codelineno-17-9></a><span class=w>    </span><span class=nt>repeat_interval</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">12h</span><span class=w></span>
<a href=#__codelineno-17-10 id=__codelineno-17-10 name=__codelineno-17-10></a><span class=w>    </span><span class=nt>routes</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-17-11 id=__codelineno-17-11 name=__codelineno-17-11></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>receiver</span><span class=p>:</span><span class=w> </span><span class=s>"slack-notifications"</span><span class=w></span>
<a href=#__codelineno-17-12 id=__codelineno-17-12 name=__codelineno-17-12></a><span class=w>        </span><span class=nt>matchers</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-17-13 id=__codelineno-17-13 name=__codelineno-17-13></a><span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">alertname="OnlineBoutiqueInstanceDown"</span><span class=w></span>
<a href=#__codelineno-17-14 id=__codelineno-17-14 name=__codelineno-17-14></a><span class=w>        </span><span class=nt>continue</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class=w></span>
<a href=#__codelineno-17-15 id=__codelineno-17-15 name=__codelineno-17-15></a><span class=w>    </span><span class=nt>receivers</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-17-16 id=__codelineno-17-16 name=__codelineno-17-16></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>"null"</span><span class=w></span>
<a href=#__codelineno-17-17 id=__codelineno-17-17 name=__codelineno-17-17></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>"slack-notifications"</span><span class=w></span>
<a href=#__codelineno-17-18 id=__codelineno-17-18 name=__codelineno-17-18></a><span class=w>        </span><span class=nt>slack_configs</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-17-19 id=__codelineno-17-19 name=__codelineno-17-19></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>channel</span><span class=p>:</span><span class=w> </span><span class=s>"#&lt;YOUR_SLACK_CHANNEL_NAME_HERE&gt;"</span><span class=w></span>
<a href=#__codelineno-17-20 id=__codelineno-17-20 name=__codelineno-17-20></a><span class=w>            </span><span class=nt>send_resolved</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w></span>
<a href=#__codelineno-17-21 id=__codelineno-17-21 name=__codelineno-17-21></a><span class=w>            </span><span class=nt>title</span><span class=p>:</span><span class=w> </span><span class=s>"{{</span><span class=nv> </span><span class=s>range</span><span class=nv> </span><span class=s>.Alerts</span><span class=nv> </span><span class=s>}}{{</span><span class=nv> </span><span class=s>.Annotations.summary</span><span class=nv> </span><span class=s>}}\n{{</span><span class=nv> </span><span class=s>end</span><span class=nv> </span><span class=s>}}"</span><span class=w></span>
<a href=#__codelineno-17-22 id=__codelineno-17-22 name=__codelineno-17-22></a><span class=w>            </span><span class=nt>text</span><span class=p>:</span><span class=w> </span><span class=s>"{{</span><span class=nv> </span><span class=s>range</span><span class=nv> </span><span class=s>.Alerts</span><span class=nv> </span><span class=s>}}{{</span><span class=nv> </span><span class=s>.Annotations.description</span><span class=nv> </span><span class=s>}}\n{{</span><span class=nv> </span><span class=s>end</span><span class=nv> </span><span class=s>}}"</span><span class=w></span>
</code></pre></div> </details> </li> <li> <p>Apply the new settings using <code>Helm</code>:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-18-1 id=__codelineno-18-1 name=__codelineno-18-1></a><span class=nv>HELM_CHART_VERSION</span><span class=o>=</span><span class=s2>"35.5.1"</span>
<a href=#__codelineno-18-2 id=__codelineno-18-2 name=__codelineno-18-2></a>
<a href=#__codelineno-18-3 id=__codelineno-18-3 name=__codelineno-18-3></a>helm upgrade kube-prom-stack prometheus-community/kube-prometheus-stack --version <span class=s2>"</span><span class=si>${</span><span class=nv>HELM_CHART_VERSION</span><span class=si>}</span><span class=s2>"</span> <span class=se>\</span>
<a href=#__codelineno-18-4 id=__codelineno-18-4 name=__codelineno-18-4></a>  --namespace monitoring <span class=se>\</span>
<a href=#__codelineno-18-5 id=__codelineno-18-5 name=__codelineno-18-5></a>  -f <span class=s2>"docs/04-production/assets/manifests/prom-stack-values-v</span><span class=si>${</span><span class=nv>HELM_CHART_VERSION</span><span class=si>}</span><span class=s2>.yaml"</span>
</code></pre></div> </li> </ol> <p>!!! info At this point you should only receieve alerts from the matching <code>OnlinqBoutiqueInstanceDown</code> alertname. Since the <code>continue</code> is set to false <code>Alertmanager</code> will only send notifications from this alert and stop sending for others. Clicking on the notification name in <code>Slack</code> will open a web browser to an unreachable web page with the internal Kubernetes DNS of the <code>Alertmanager</code> pod. This is expected. For more information you can check out this <a href=https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/ >article</a>. For additional information about the configuration parameters for <code>Alertmanager</code> you can check out this <a href=https://prometheus.io/docs/alerting/latest/configuration/ >doc</a>. You can also at some notification examples in this <a href=https://prometheus.io/docs/alerting/latest/notification_examples/ >article</a>.</p> <h2 id=setting-up-event-exporter-for-events-retention>Setting up Event Exporter for events retention</h2> <p>A Kubernetes event is an object that shows what’s happening inside a cluster, node, pod, or container. These objects are usually generated in response to changes that occur inside your K8s system. The Kubernetes API Server enables all core components to create these events. Generally, each event is accompanied by a log message as well. Event objects are not regular log events, therefore the Kubernetes logs do not include them. Kubernetes has no builtin support to store or forward these events on the long term, and they are cleaned up after a short retention time defaulting to just 1 hour. In this section you will learn how to configure the <a href=https://github.com/resmoio/kubernetes-event-exporter>Kubernetes Events Exporter</a> and collect and perist those events using <code>Loki</code>.</p> <ol> <li> <p>Create the <code>ServiceAccount</code>, <code>ClusterRole</code> and <code>ClusterRoleBinding</code> using <code>kubectl</code>:</p> <p>The manifest file looks like the following:</p> <details class=note> <summary>Click to expand the manifest file</summary> <div class=highlight><pre><span></span><code><a href=#__codelineno-19-1 id=__codelineno-19-1 name=__codelineno-19-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class=w></span>
<a href=#__codelineno-19-2 id=__codelineno-19-2 name=__codelineno-19-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span><span class=w></span>
<a href=#__codelineno-19-3 id=__codelineno-19-3 name=__codelineno-19-3></a><span class=nt>metadata</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-19-4 id=__codelineno-19-4 name=__codelineno-19-4></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">event-exporter</span><span class=w></span>
<a href=#__codelineno-19-5 id=__codelineno-19-5 name=__codelineno-19-5></a><span class=nn>---</span><span class=w></span>
<a href=#__codelineno-19-6 id=__codelineno-19-6 name=__codelineno-19-6></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class=w></span>
<a href=#__codelineno-19-7 id=__codelineno-19-7 name=__codelineno-19-7></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span><span class=w></span>
<a href=#__codelineno-19-8 id=__codelineno-19-8 name=__codelineno-19-8></a><span class=nt>metadata</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-19-9 id=__codelineno-19-9 name=__codelineno-19-9></a><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">event-exporter</span><span class=w></span>
<a href=#__codelineno-19-10 id=__codelineno-19-10 name=__codelineno-19-10></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">event-exporter</span><span class=w></span>
<a href=#__codelineno-19-11 id=__codelineno-19-11 name=__codelineno-19-11></a><span class=nn>---</span><span class=w></span>
<a href=#__codelineno-19-12 id=__codelineno-19-12 name=__codelineno-19-12></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span><span class=w></span>
<a href=#__codelineno-19-13 id=__codelineno-19-13 name=__codelineno-19-13></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRoleBinding</span><span class=w></span>
<a href=#__codelineno-19-14 id=__codelineno-19-14 name=__codelineno-19-14></a><span class=nt>metadata</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-19-15 id=__codelineno-19-15 name=__codelineno-19-15></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">event-exporter</span><span class=w></span>
<a href=#__codelineno-19-16 id=__codelineno-19-16 name=__codelineno-19-16></a><span class=nt>roleRef</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-19-17 id=__codelineno-19-17 name=__codelineno-19-17></a><span class=w>    </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span><span class=w></span>
<a href=#__codelineno-19-18 id=__codelineno-19-18 name=__codelineno-19-18></a><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span><span class=w></span>
<a href=#__codelineno-19-19 id=__codelineno-19-19 name=__codelineno-19-19></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">view</span><span class=w></span>
<a href=#__codelineno-19-20 id=__codelineno-19-20 name=__codelineno-19-20></a><span class=nt>subjects</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-19-21 id=__codelineno-19-21 name=__codelineno-19-21></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span><span class=w></span>
<a href=#__codelineno-19-22 id=__codelineno-19-22 name=__codelineno-19-22></a><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">event-exporter</span><span class=w></span>
<a href=#__codelineno-19-23 id=__codelineno-19-23 name=__codelineno-19-23></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">event-exporter</span><span class=w></span>
</code></pre></div> </details> <div class=highlight><pre><span></span><code><a href=#__codelineno-20-1 id=__codelineno-20-1 name=__codelineno-20-1></a>kubectl apply -f docs/04-production/assets/manifests/event-exporter-roles.yaml
</code></pre></div> </li> <li> <p>Create the <code>event exporter</code> config using <code>kubectl</code>:</p> <p>The manifest file for the config looks like the following:</p> <details class=note> <summary>Click to expand the config manifest file</summary> <div class=highlight><pre><span></span><code><a href=#__codelineno-21-1 id=__codelineno-21-1 name=__codelineno-21-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class=w></span>
<a href=#__codelineno-21-2 id=__codelineno-21-2 name=__codelineno-21-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span><span class=w></span>
<a href=#__codelineno-21-3 id=__codelineno-21-3 name=__codelineno-21-3></a><span class=nt>metadata</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-21-4 id=__codelineno-21-4 name=__codelineno-21-4></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">event-exporter-cfg</span><span class=w></span>
<a href=#__codelineno-21-5 id=__codelineno-21-5 name=__codelineno-21-5></a><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">event-exporter</span><span class=w></span>
<a href=#__codelineno-21-6 id=__codelineno-21-6 name=__codelineno-21-6></a><span class=nt>data</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-21-7 id=__codelineno-21-7 name=__codelineno-21-7></a><span class=w>    </span><span class=nt>config.yaml</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|</span><span class=w></span>
<a href=#__codelineno-21-8 id=__codelineno-21-8 name=__codelineno-21-8></a><span class=w>    </span><span class=nt>logLevel</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">error</span><span class=w></span>
<a href=#__codelineno-21-9 id=__codelineno-21-9 name=__codelineno-21-9></a><span class=w>    </span><span class=nt>logFormat</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">json</span><span class=w></span>
<a href=#__codelineno-21-10 id=__codelineno-21-10 name=__codelineno-21-10></a><span class=w>    </span><span class=nt>route</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-21-11 id=__codelineno-21-11 name=__codelineno-21-11></a><span class=w>        </span><span class=nt>routes</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-21-12 id=__codelineno-21-12 name=__codelineno-21-12></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>match</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-21-13 id=__codelineno-21-13 name=__codelineno-21-13></a><span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>receiver</span><span class=p>:</span><span class=w> </span><span class=s>"dump"</span><span class=w></span>
<a href=#__codelineno-21-14 id=__codelineno-21-14 name=__codelineno-21-14></a><span class=w>    </span><span class=nt>receivers</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-21-15 id=__codelineno-21-15 name=__codelineno-21-15></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s>"dump"</span><span class=w></span>
<a href=#__codelineno-21-16 id=__codelineno-21-16 name=__codelineno-21-16></a><span class=w>        </span><span class=nt>stdout</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{}</span><span class=w></span>
</code></pre></div> </details> <div class=highlight><pre><span></span><code><a href=#__codelineno-22-1 id=__codelineno-22-1 name=__codelineno-22-1></a>kubectl apply -f docs/04-production/assets/manifests/event-exporter-config.yaml
</code></pre></div> </li> <li> <p>Finally, create the <code>event exporter</code> deployment using kubectl:</p> <p>The manifest file for the deployment looks like the following:</p> <details class=note> <summary>Click to expand the deployment manifest file</summary> <div class=highlight><pre><span></span><code><a href=#__codelineno-23-1 id=__codelineno-23-1 name=__codelineno-23-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span><span class=w></span>
<a href=#__codelineno-23-2 id=__codelineno-23-2 name=__codelineno-23-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span><span class=w></span>
<a href=#__codelineno-23-3 id=__codelineno-23-3 name=__codelineno-23-3></a><span class=nt>metadata</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-23-4 id=__codelineno-23-4 name=__codelineno-23-4></a><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">event-exporter</span><span class=w></span>
<a href=#__codelineno-23-5 id=__codelineno-23-5 name=__codelineno-23-5></a><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">event-exporter</span><span class=w></span>
<a href=#__codelineno-23-6 id=__codelineno-23-6 name=__codelineno-23-6></a><span class=nt>spec</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-23-7 id=__codelineno-23-7 name=__codelineno-23-7></a><span class=w>    </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class=w></span>
<a href=#__codelineno-23-8 id=__codelineno-23-8 name=__codelineno-23-8></a><span class=w>    </span><span class=nt>template</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-23-9 id=__codelineno-23-9 name=__codelineno-23-9></a><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-23-10 id=__codelineno-23-10 name=__codelineno-23-10></a><span class=w>        </span><span class=nt>labels</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-23-11 id=__codelineno-23-11 name=__codelineno-23-11></a><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">event-exporter</span><span class=w></span>
<a href=#__codelineno-23-12 id=__codelineno-23-12 name=__codelineno-23-12></a><span class=w>        </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class=w></span>
<a href=#__codelineno-23-13 id=__codelineno-23-13 name=__codelineno-23-13></a><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-23-14 id=__codelineno-23-14 name=__codelineno-23-14></a><span class=w>        </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">event-exporter</span><span class=w></span>
<a href=#__codelineno-23-15 id=__codelineno-23-15 name=__codelineno-23-15></a><span class=w>        </span><span class=nt>containers</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-23-16 id=__codelineno-23-16 name=__codelineno-23-16></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">event-exporter</span><span class=w></span>
<a href=#__codelineno-23-17 id=__codelineno-23-17 name=__codelineno-23-17></a><span class=w>            </span><span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/resmoio/kubernetes-event-exporter:latest</span><span class=w></span>
<a href=#__codelineno-23-18 id=__codelineno-23-18 name=__codelineno-23-18></a><span class=w>            </span><span class="l l-Scalar l-Scalar-Plain">imagePullPolicy</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class=w></span>
<a href=#__codelineno-23-19 id=__codelineno-23-19 name=__codelineno-23-19></a><span class=w>            </span><span class="l l-Scalar l-Scalar-Plain">args</span><span class="p p-Indicator">:</span><span class=w></span>
<a href=#__codelineno-23-20 id=__codelineno-23-20 name=__codelineno-23-20></a><span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">-conf=/data/config.yaml</span><span class=w></span>
<a href=#__codelineno-23-21 id=__codelineno-23-21 name=__codelineno-23-21></a><span class=w>            </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-23-22 id=__codelineno-23-22 name=__codelineno-23-22></a><span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/data</span><span class=w></span>
<a href=#__codelineno-23-23 id=__codelineno-23-23 name=__codelineno-23-23></a><span class=w>                </span><span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cfg</span><span class=w></span>
<a href=#__codelineno-23-24 id=__codelineno-23-24 name=__codelineno-23-24></a><span class=w>        </span><span class=nt>volumes</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-23-25 id=__codelineno-23-25 name=__codelineno-23-25></a><span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cfg</span><span class=w></span>
<a href=#__codelineno-23-26 id=__codelineno-23-26 name=__codelineno-23-26></a><span class=w>            </span><span class="l l-Scalar l-Scalar-Plain">configMap</span><span class="p p-Indicator">:</span><span class=w></span>
<a href=#__codelineno-23-27 id=__codelineno-23-27 name=__codelineno-23-27></a><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">event-exporter-cfg</span><span class=w></span>
<a href=#__codelineno-23-28 id=__codelineno-23-28 name=__codelineno-23-28></a><span class=w>    </span><span class=nt>selector</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-23-29 id=__codelineno-23-29 name=__codelineno-23-29></a><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w></span>
<a href=#__codelineno-23-30 id=__codelineno-23-30 name=__codelineno-23-30></a><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">event-exporter</span><span class=w></span>
<a href=#__codelineno-23-31 id=__codelineno-23-31 name=__codelineno-23-31></a><span class=w>        </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class=w></span>
</code></pre></div> </details> <div class=highlight><pre><span></span><code><a href=#__codelineno-24-1 id=__codelineno-24-1 name=__codelineno-24-1></a>kubectl apply -f docs/04-production/assets/manifests/event-exporter-deployment.yaml
</code></pre></div> </li> </ol> <h2 id=viewing-events-in-grafana>Viewing events in Grafana</h2> <p>If the installation went well and no errors were reported you should start seeing event start to flow in Grafana.</p> <ol> <li> <p>Connect to <code>Grafana</code> (using default credentials: <code>admin/prom-operator</code>) by port forwarding to local machine:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-25-1 id=__codelineno-25-1 name=__codelineno-25-1></a>kubectl --namespace monitoring port-forward svc/kube-prom-stack-grafana <span class=m>3000</span>:80
</code></pre></div> </li> <li> <p>Open a web browser on <a href=http://localhost:3000>localhost:3000</a>. Once in, you can go to <code>Explore</code> menu and select the <code>Loki</code> as a datasource.</p> </li> <li> <p>In the <code>Log browser</code> input enter the following:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-26-1 id=__codelineno-26-1 name=__codelineno-26-1></a><span class=p>{</span><span class=err>app=</span><span class=s2>"event-exporter"</span><span class=p>}</span><span class=w></span>
</code></pre></div> <div class="admonition info"> <p class=admonition-title>Info</p> <p>You should see events in the <code>Logs</code> section. Any of the fields in the <code>Detected fields</code> section of a log detail view can be used to query. For example you can perform a query using the pod name and view specific logs for a certain pod: <code>{app="event-exporter"} |= "shippingservice-79bdd5f858-gqm6g"</code>.</p> </div> <p><a class=glightbox data-desc-position=bottom data-description data-height=auto data-title data-width=100% href=../../assets/loki_kubernetes_events.png><img alt="loki kubernetes events" src=../../assets/loki_kubernetes_events.png></a></p> </li> </ol> <p>For a more in depth explanation on the <code>Obervability</code> topic you can check out the <a href=https://github.com/digitalocean/Kubernetes-Starter-Kit-Developers>Kubernetes Starter Kit Tutorial</a>.</p> <p>Next, you will learn how to configure the CI/CD process and associated GitHub workflows for all project components used in this guide.</p> </article> </div> </div> </main> <footer class=md-footer> <nav aria-label=Footer class="md-footer__inner md-grid"> <a aria-label="Previous: Set up ingress" class="md-footer__link md-footer__link--prev" href=../setup-ingress-production/ rel=prev> <div class="md-footer__button md-icon"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Set up ingress </div> </div> </a> <a aria-label="Next: Set up continuous integration" class="md-footer__link md-footer__link--next" href=../../05-ci-cd/setup-continuous-integration/ rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Set up continuous integration </div> </div> <div class="md-footer__button md-icon"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> DigitalOcean </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ rel=noopener target=_blank> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../../assets/javascripts/bundle.d6c3db9e.min.js></script> <script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom"});})</script></body> </html>